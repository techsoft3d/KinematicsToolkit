var KT;(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{KinematicsAnimationGroup:()=>vt,KinematicsComponent:()=>C,KinematicsHierachy:()=>Pt,KinematicsManager:()=>Tt,componentType:()=>x,pivotSystemType:()=>d});class n{static nearestPointOnLine(t,e,n){e.normalize();var o=Communicator.Point3.subtract(n,t),i=Communicator.Point3.dot(o,e),r=Communicator.Point3.add(t,Communicator.Point3.scale(e,i));return Communicator.Point3.subtract(r,n),r}static closestPointOnPlane(t,e){let n=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(n*t.normal.x,n*t.normal.y,n*t.normal.z))}static signedAngle(t,e,n){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),n),Communicator.Point3.dot(t,e))*(180/Math.PI)}static ComputeVectorToVectorRotationMatrix(t,e){const n=1e-7;t.normalize(),e.normalize();let o=Communicator.Point3.cross(t,e),i=Communicator.Point3.dot(t,e),r=o.length();if(r>-1e-7&&r<n){if(!(i<0))return new Communicator.Matrix;if(t.x<-1e-7||t.x>n)o.x=t.y,o.y=-t.x,o.z=0;else if(t.y<-1e-7||t.y>n)o.x=-t.y,o.y=t.x,o.z=0;else{if(!(t.z<-1e-7||t.z>n))return new Communicator.Matrix;o.x=-t.z,o.z=t.x,o.y=0}}var a=Math.atan2(r,i);return a*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(o,a)}static generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}static computeOffaxisRotationMatrix(t,e,n){let o=new Communicator.Matrix,i=new Communicator.Matrix;i=new Communicator.Matrix,i.setTranslationComponent(-t.x,-t.y,-t.z);let r=new Communicator.Matrix;r.setTranslationComponent(t.x,t.y,t.z),Communicator.Util.computeOffaxisRotation(e,n,o);let a=Communicator.Matrix.multiply(i,o);return Communicator.Matrix.multiply(a,r)}static circleIntersection(t,e,n,o,i,r){let a,s,l,h,m,c,p,_,u;if(s=o-t,l=i-e,h=Math.sqrt(l*l+s*s),h>n+r)return!1;if(h<Math.abs(n-r))return!1;a=(n*n-r*r+h*h)/(2*h),_=t+s*a/h,u=e+l*a/h,m=Math.sqrt(n*n-a*a),c=m/h*-l,p=s*(m/h);let d=_+c,g=_-c,x=u+p,C=u-p;return{p1:new Communicator.Point3(d,x,0),p2:new Communicator.Point3(g,C,0)}}static circleLineIntersection(t,e,n,o,i,r,a){let s=null,l=null,h=null,m=null,c=i-a,p=r-o,_=o*a-i*r;if(0==p){let o=-2*n,i=o*o-4*(e*e+n*n+2*e*_/c+_*_/(c*c)-t*t);if(i<0)return;s=-_/c,l=(-o+Math.sqrt(i))/2,i>0&&(h=s,m=(-o-Math.sqrt(i))/2)}else{let o=c*c/(p*p)+1,i=2*(c*_/(p*p)-e+c*n/p),r=i*i-4*o*(e*e+n*n+2*n*_/p+_*_/(p*p)-t*t);if(r<0)return;s=(-i+Math.sqrt(r))/(2*o),l=-c/p*s-_/p,r>0&&(h=(-i-Math.sqrt(r))/(2*o),m=-c/p*h-_/p)}return{x1:s,y1:l,x2:h,y2:m}}}class o{constructor(){this._wheels=[],this._poslookup=[],this._baseNode=null,this._nodeids=[],this._segmentnum=500,this._width=10,this._thickness=10,this._gap=.1,this._tracks=0,this._alignvector=null,this._trackorientation=!1,this._color1=new Communicator.Color(64,64,64),this._color2=new Communicator.Color(20,20,20),this._standinNodes=[]}getBaseNode(){return this._baseNode}getWidth(){return this._width}setWidth(t){this._width=t}setSegmentNum(t){this._segmentnum=t}getSegmentNum(){return this._segmentnum}setThickness(t){this._thickness=t}getThickness(){return this._thickness}setGap(t){this._gap=t}getGap(){return this._gap}setTracks(t){this._tracks=t}getTracks(){return this._tracks}setTrackOrientation(t){this._trackorientation=t}getTrackOrientation(){return this._trackorientation}setAlignVector(t){this._alignvector=t}getAlignVector(){return this._alignvector}setColor1(t){this._color1=t}getColor1(){return this._color1}setColor2(t){this._color2=t}getColor2(){return this._color2}getWheelByIndex(t){return this._wheels[t]}getWheels(){return this._wheels}setStandinNodes(t){this._standinNodes=t}initializeWheels(){this.calcuateAlignMatrix();for(let t=0;t<this._wheels.length;t++){let e=this._wheels[t],n=this.alignmatrix.transform(e.component.getCenter());e.pos=new Communicator.Point3(n.x,n.y,0)}}addWheel(){this._wheels.push({pos:null,radius:0,component:null,inner:!1,other:!1})}insertWheel(t){this_wheels.splice(t,0,{pos:null,radius:0,component:null,inner:!1,other:!1})}deleteWheel(t){this_wheels.splice(t,1)}toJson(){let t={alignvector:this._alignvector?this._alignvector.toJson():null,wheels:[],segmentnum:this._segmentnum,width:this._width,thickness:this._thickness,gap:this._gap,tracks:this._tracks,trackorientation:this._trackorientation,color1:this._color1.toJson(),color2:this._color2.toJson()};for(let e=0;e<this._wheels.length;e++)t.wheels.push({radius:this._wheels[e].radius,component:this._wheels[e].component.getId(),inner:this._wheels[e].inner,other:this._wheels[e].other});return t.standinNodes=this._standinNodes,t}fromJson(t,e){this._segmentnum=t.segmentnum,t.width&&(this._width=t.width),t.thickness&&(this._thickness=t.thickness),t.color1&&(this._color1=Communicator.Color.fromJson(t.color1)),t.alignvector&&(this._alignvector=Communicator.Point3.fromJson(t.alignvector)),t.color2&&(this._color2=Communicator.Color.fromJson(t.color2)),this._gap=t.gap,this._tracks=t.tracks,t.trackorientation&&(this._trackorientation=t.trackorientation);for(let n=0;n<t.wheels.length;n++)this._wheels.push({pos:null,radius:t.wheels[n].radius,component:e.getHierachy().getComponentHash()[t.wheels[n].component],inner:t.wheels[n].inner,other:t.wheels[n].other});return t.standinNodes&&(this._standinNodes=t.standinNodes),t}calcuateAlignMatrix(){let t;this._wheels.length>2&&!this._alignvector?(t=Communicator.Plane.createFromPoints(this._wheels[0].component.getCenter(),this._wheels[1].component.getCenter(),this._wheels[2].component.getCenter()),this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(t.normal,new Communicator.Point3(0,0,1))):this._alignvector?this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(this._alignvector,new Communicator.Point3(0,0,1)):this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(1,0,0),new Communicator.Point3(0,0,1));let e=this.alignmatrix.transform(this._wheels[0].component.getCenter()),o=new Communicator.Matrix;o.setTranslationComponent(0,0,-e.z),this.alignmatrix=Communicator.Matrix.multiply(this.alignmatrix,o)}addBoxMesh(t,e,n,o){let i=[t.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,e.x,e.y,t.z,t.x,e.y,t.z,t.x,t.y,t.z,e.x,e.y,t.z,t.x,t.y,t.z,e.x,t.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,e.z,t.x,t.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,e.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z],r=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0];for(let t=0;t<i.length;t++)n.push(i[t]);for(let t=0;t<r.length;t++)o.push(r[t])}async createMesh(t,e,n){let o=new Communicator.MeshData;o.setFaceWinding(Communicator.FaceWinding.Clockwise);let i=[],r=[];if(0==n)this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,e.y,e.z),i,r);else{this._trackorientation?this.addBoxMesh(new Communicator.Point3(-e.x,0,-e.z),new Communicator.Point3(e.x,e.y,e.z),i,r):this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,0,e.z),i,r);let t=2*e.x/(3*n),o=-e.x+t/2;for(let a=0;a<n;a++)this._trackorientation?this.addBoxMesh(new Communicator.Point3(o,-e.y,-e.z),new Communicator.Point3(o+2*t,0,e.z),i,r):this.addBoxMesh(new Communicator.Point3(o,0,-e.z),new Communicator.Point3(o+2*t,e.y,e.z),i,r),o+=2*t+t}return o.addFaces(i,r),await t.model.createMesh(o)}findCircleTangents(t,e){let n=t.pos.x,o=t.pos.y,i=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(i*a-n*s)/(a-s),h=(r*a-o*s)/(a-s),m=(Math.pow(a,2)*(l-n)+a*(h-o)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+n,c=(Math.pow(a,2)*(l-n)-a*(h-o)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+n,p=(Math.pow(a,2)*(h-o)-a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+o,_=(Math.pow(a,2)*(h-o)+a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+o,u=(Math.pow(s,2)*(l-i)+s*(h-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+i,d=(Math.pow(s,2)*(l-i)-s*(h-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+i,g=(Math.pow(s,2)*(h-r)-s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+r,x=(Math.pow(s,2)*(h-r)+s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+r;return{xt1:new Communicator.Point3(m,p,0),xt2:new Communicator.Point3(c,_,0),xt3:new Communicator.Point3(u,g,0),xt4:new Communicator.Point3(d,x,0)}}findCircleInnerTangents(t,e){let n=t.pos.x,o=t.pos.y,i=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(i*a+n*s)/(a+s),h=(r*a+o*s)/(a+s),m=(Math.pow(a,2)*(l-n)+a*(h-o)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+n,c=(Math.pow(a,2)*(l-n)-a*(h-o)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+n,p=(Math.pow(a,2)*(h-o)-a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+o,_=(Math.pow(a,2)*(h-o)+a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(h-o,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(h-o,2))+o,u=(Math.pow(s,2)*(l-i)+s*(h-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+i,d=(Math.pow(s,2)*(l-i)-s*(h-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+i,g=(Math.pow(s,2)*(h-r)-s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+r,x=(Math.pow(s,2)*(h-r)+s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(h-r,2))+r;return{xt1:new Communicator.Point3(m,p,0),xt2:new Communicator.Point3(c,_,0),xt3:new Communicator.Point3(u,g,0),xt4:new Communicator.Point3(d,x,0)}}async initialize(){for(let t=0;t<this._standinNodes.length;t++)Tt.viewer.model.setNodesVisibility([this._standinNodes[t]],!1);this.initializeWheels();for(let t=0;t<this._wheels.length;t++){let e,n=t==this._wheels.length-1?0:t+1;this._wheels[t].inner?(e=this.findCircleInnerTangents(this._wheels[t],this._wheels[n]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[n].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[n].enterpos=e.xt3.copy())):(e=this.findCircleTangents(this._wheels[t],this._wheels[n]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[n].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[n].enterpos=e.xt3.copy()))}for(let t=0;t<this._wheels.length;t++)this._wheels[t].rotation=this.calculateWheelRotation(t);this.calculateTotalLength();let t=0;this._poslookup=[];for(let e=0;e<1e4;e++){t+=1e-4;let e=new Communicator.Matrix,n=this.computePositionOnBelt(t);e.setTranslationComponent(n.pos.x,n.pos.y,n.pos.z);let o=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),n.angle,o);let i=Communicator.Matrix.multiply(o,e);this._poslookup.push(i)}let e=this._totalLength/this._segmentnum,n=await this.createMesh(Tt.viewer,new Communicator.Point3(e/2-e*this._gap+1e-4,this._thickness,this._width),this._tracks),o=new Communicator.MeshInstanceData(n);this._baseNode&&await Tt.viewer.model.deleteNode(this._baseNode),this._baseNode=Tt.viewer.model.createNode(Tt.viewer.model.getRootNode()),this.adjustnode=Tt.viewer.model.createNode(this._baseNode),this._nodeids=[];for(let t=0;t<this._segmentnum;t++)this._nodeids[t]=await Tt.viewer.model.createMeshInstance(o,this.adjustnode),t%2?Tt.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color1):Tt.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color2);Tt.viewer.model.setMetallicRoughness([this._baseNode],.2,.6),Tt.viewer.model.setNodeMatrix(this.adjustnode,Communicator.Matrix.inverse(this.alignmatrix)),this.move(0)}calculateTotalLength(){this._totalLength=0;for(let t=0;t<this._wheels.length;t++){0==t&&this._wheels.length;let e=t==this._wheels.length-1?0:t+1,n=this._wheels[t];this._totalLength+=this.calculateCircumference(n.radius,n.rotation.steps),this._totalLength+=Communicator.Point3.subtract(n.exitpos,this._wheels[e].enterpos).length()}}computePositionOnBelt(t){let e=this._totalLength*t,o=0,i=0,r=Communicator.Point3.subtract(this._wheels[0].enterpos,this._wheels[this._wheels.length-1].exitpos).normalize();i=n.signedAngle(r,new Communicator.Point3(-1,0,0),new Communicator.Point3(0,0,-1));for(let t=0;t<this._wheels.length;t++){let n=t==this._wheels.length-1?0:t+1,r=this._wheels[t],a=this.calculateCircumference(r.radius,r.rotation.steps),s=Communicator.Point3.subtract(r.exitpos,this._wheels[n].enterpos).length();if(!(o+a<e)){let n=(e-o)/a*r.rotation.steps;return i+=Math.sign(r.rotation.angle)*n,{pos:this.wheelRotation(this._wheels[t],this._wheels[t].enterpos,Math.sign(r.rotation.angle)*n),angle:i}}if(o+=a,i+=Math.sign(r.rotation.angle)*r.rotation.steps,!(o+s<e)){let a=e-o,s=Communicator.Point3.subtract(this._wheels[n].enterpos,r.exitpos).normalize();return{pos:Communicator.Point3.add(this._wheels[t].exitpos,Communicator.Point3.scale(s,a)),angle:i}}o+=s}}calculateWheelRotation(t){let e=0==t?this._wheels.length-1:t-1,o=(this._wheels.length,this._wheels[t]),i=Communicator.Point3.subtract(o.enterpos,o.pos).normalize(),r=Communicator.Point3.subtract(o.exitpos,o.pos).normalize(),a=n.signedAngle(i,r,new Communicator.Point3(0,0,1)),s=Communicator.Point3.subtract(o.enterpos,this._wheels[e].exitpos).length(),l=this.wheelRotation(o,o.enterpos,2*Math.sign(a)),h=Communicator.Point3.subtract(l,this._wheels[e].exitpos).length(),m=Math.abs(a);return h<s&&(m=360-Math.abs(a),a=-a),{steps:m,angle:a}}wheelRotation(t,e,n){let o=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),n,o);let i=new Communicator.Matrix;i.setTranslationComponent(-t.pos.x,-t.pos.y,0);let r=new Communicator.Matrix;r.setTranslationComponent(t.pos.x,t.pos.y,0);let a=Communicator.Matrix.multiply(i,o);return Communicator.Matrix.multiply(a,r).transform(e)}async move(t){let e=this._totalLength/this._segmentnum;for(let n=0;n<this._segmentnum;n++)this.moveInternal(t+n*e,this._nodeids[n])}async moveInternal(t,e){let n=t%this._totalLength;n<0&&(n=this._totalLength+n);let o=Math.floor(n/this._totalLength*this._poslookup.length);Tt.viewer.model.setNodeMatrix(e,this._poslookup[o])}animate(){let t=this;setInterval((function(){t.move(mover),mover+=.2}),10)}calculateCircumference(t,e){return e/360*2*Math.PI*t}calculateCircumferenceAngle(t,e){return e/(2*Math.PI*t)*360}}class i{constructor(t){this._component=t,this._type=x.revolute,this._fixedAxis=null,this._fixedAxisTarget=null}getType(){return this._type}setFixedAxis(t){this._fixedAxis=t}setFixedAxisTarget(t){this._fixedAxisTarget=t}getFixedAxis(){return this._fixedAxis}setFixedAxisFromMatrix(t){let e=Tt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(Tt.getHandleOperator().getPosition()){if(!Tt.getHandleOperator().getSecondAxis())return;let n=Communicator.Point3.add(e.getPosition(),Tt.getHandleOperator().getSecondAxis());t.transform(e.getPosition()),n=t.transform(n),this._fixedAxis=Communicator.Point3.subtract(n,this.center).normalize(),this._fixedAxisTarget=new Communicator.Point3(0,-1,0)}}async fromJson(t,e){if(t.fixedAxis){if(null==e){let e=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxis=Communicator.Point3.subtract(e,this._component._center).normalize()}else this._fixedAxis=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxisTarget=Communicator.Point3.fromJson(t.fixedAxisTarget)}}jsonFixup(){}toJson(t){this._fixedAxis&&(t.fixedAxis=this._fixedAxis.toJson(),t.fixedAxisTarget=this._fixedAxisTarget.toJson())}getCurrentValue(){return this._component._currentAngle}set(t){this._component._rotate(t)}getMovementType(){return x.revolute}async execute(){let t=this._component;if(this._fixedAxis){let e=t.transformlocalPointToWorldSpace(t._center),o=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,this._fixedAxis)),i=Communicator.Point3.subtract(o,e).normalize(),r=this._fixedAxisTarget,a=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,e).normalize(),l=Communicator.Plane.createFromPointAndNormal(e,s),h=(l.distanceToPoint(new Communicator.Point3.add(e,r)),n.closestPointOnPlane(l,new Communicator.Point3.add(e,r)));r=new Communicator.Point3.subtract(h,e).normalize();let m=Communicator.Util.computeAngleBetweenVector(i,r);await t._rotate(m,!0,!0),e=t.transformlocalPointToWorldSpace(t._center),o=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,this._fixedAxis));let c=Communicator.Point3.subtract(o,e).normalize();Communicator.Point3.subtract(c,r).length()>.001&&await t._rotate(2*-m,!0,!0)}}}class r{constructor(t){this._component=t,this._type=x.prismatic}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getCurrentValue(){return this._component._currentPosition}set(t){this._component._translate(t)}getMovementType(){return x.prismatic}async execute(){}}class a{constructor(t){this._component=t,this._type=x.pistonController,this._extraComponent1=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1]}toJson(t){t.extraComponent1=this._extraComponent1._id}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}async execute(){let t=this._component,e=t._parent.transformlocalPointToWorldSpace(t._center),o=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),i=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),r=this._extraComponent1._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._extraComponent1._center,this._extraComponent1._axis)),a=Communicator.Point3.subtract(r,i).normalize(),s=n.nearestPointOnLine(i,a,e),l=Communicator.Point3.subtract(s,e).length(),h=Communicator.Point3.subtract(this._extraComponent1._center,t._center).length(),m=Math.sqrt(h*h-l*l),c=Math.asin(m/h)*(180/Math.PI),p=new Communicator.Matrix,_=new Communicator.Matrix,u=Communicator.Point3.subtract(o,e).normalize();_=new Communicator.Matrix,_.setTranslationComponent(-e.x,-e.y,-e.z);let d=new Communicator.Matrix;d.setTranslationComponent(e.x,e.y,e.z),Communicator.Util.computeOffaxisRotation(u,-c,p);let g=Communicator.Matrix.multiply(_,p),x=Communicator.Matrix.multiply(g,d),C=Communicator.Point3.subtract(s,e).normalize();C.scale(m);let f=Communicator.Point3.add(e,C),v=x.transform(f);p=new Communicator.Matrix,Communicator.Util.computeOffaxisRotation(u,c,p),g=Communicator.Matrix.multiply(_,p),x=Communicator.Matrix.multiply(g,d),C=Communicator.Point3.subtract(s,e).normalize(),C.scale(m),f=Communicator.Point3.add(e,C);let y=x.transform(f),P=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),w=Communicator.Point3.subtract(v,P).length();Communicator.Point3.subtract(y,P).length()<w&&(v=y);let M=t._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),T=Communicator.Point3.subtract(M,e).normalize(),b=Communicator.Point3.subtract(v,e).normalize(),N=Communicator.Util.computeAngleBetweenVector(T,b);await t._rotate(-N),M=t.transformlocalPointToWorldSpace(this._extraComponent1._center);let A=Communicator.Point3.subtract(M,v).length();await t._rotate(N),M=t.transformlocalPointToWorldSpace(this._extraComponent1._center),Communicator.Point3.subtract(M,v).length()>A&&await t._rotate(-N);let S=Communicator.Point3.subtract(this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length();await this._extraComponent1._translate(-S);let H=Communicator.Point3.subtract(this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length();await this._extraComponent1._translate(S),Communicator.Point3.subtract(this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length()>H&&await this._extraComponent1._translate(-S)}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}adjustExtraComponentToPistonController(){let t=this._component,e=t._axis,o=Communicator.Plane.createFromPointAndNormal(t._center,e),i=n.closestPointOnPlane(o,this._extraComponent1._center);this._extraComponent1._axis=this._extraComponent1._axis.copy(),this._extraComponent1._center=i}}class s{constructor(t){this._component=t,this._type=x.fixed}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getMovementType(){return x.fixed}getCurrentValue(){}set(t){}async execute(){}}class l{constructor(t){this._component=t,this._type=x.target}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}async execute(){}}class h{constructor(t){this._component=t,this._type=x.prismaticTriangle,this._extraComponent1=null,this._extraComponent2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}async execute(){let t=this._component,e=this._extraComponent1.transformlocalPointToWorldSpace(t._center),n=this._extraComponent2.transformlocalPointToWorldSpace(this._extraComponent2._center),o=this._extraComponent2._parent.transformlocalPointToWorldSpace(t._center),i=Communicator.Point3.subtract(n,e),r=Communicator.Point3.subtract(n,o),a=i.length(),s=r.length();i.normalize(),r.normalize();let l=Communicator.Util.computeAngleBetweenVector(i,r);await this._extraComponent2._rotate(-l,!0);let h=this._extraComponent2.transformlocalPointToWorldSpace(t._center),m=Communicator.Point3.subtract(h,e).length();await this._extraComponent2._rotate(l,!0),h=this._extraComponent2.transformlocalPointToWorldSpace(t._center),Communicator.Point3.subtract(h,e).length()>m&&await this._extraComponent2._rotate(-l,!0),await this._extraComponent2._updateReferenceNodeMatrices(),await t._translate(a-s)}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}adjustExtraComponentToPistonController(){let t=this._component,e=t._axis,o=Communicator.Plane.createFromPointAndNormal(t._center,e),i=n.closestPointOnPlane(o,this._extraComponent1._center);this._extraComponent1._axis=this._extraComponent1._axis.copy(),this._extraComponent1._center=i}}class m{constructor(t){this._component=t,this._type=x.mapped,this._mappedType=null,this._mappedTargetComponent=null,this._helicalFactor=1,this._prismaticPlanePlane=null,this._prismaticPlaneTip=null}getType(){return this._type}async fromJson(t,e){if(this._mappedType=t.mappedType,this._helicalFactor=t.helicalFactor,this._mappedTargetComponent=t.mappedTargetComponent,this._mappedType==x.belt&&(this.belt=new o,this.belt.fromJson(t.belt,this._component)),this._mappedType==x.prismaticPlane){let e=Communicator.Point3.fromJson(t._prismaticPlanePlane.normal);this._prismaticPlanePlane=new Communicator.Plane,this._prismaticPlanePlane.d=t._prismaticPlanePlane.d,this._prismaticPlanePlane.normal=e,this._prismaticPlaneTip=Communicator.Point3.fromJson(t._prismaticPlaneTip)}}async jsonFixup(){this._mappedTargetComponent=this._component.getHierachy().getComponentHash()[this._mappedTargetComponent],this._mappedType==x.belt&&(await this.belt.initialize(),this._component._referenceNodes.push({nodeid:this.belt.getBaseNode(),matrix:new Communicator.Matrix}))}toJson(t){t.mappedType=this._mappedType,this._mappedType==x.belt&&(t.parentMatrix=(new Communicator.Matrix).toJson()),t.helicalFactor=this._helicalFactor,t.mappedTargetComponent=this._mappedTargetComponent._id,this._mappedType==x.belt&&(t.belt=this.belt.toJson()),this._mappedType==x.prismaticPlane&&(t._prismaticPlanePlane={d:this._prismaticPlanePlane.d,normal:this._prismaticPlanePlane.normal.toJson()},t._prismaticPlaneTip=this._prismaticPlaneTip.toJson())}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}async execute(){let t=this._component;if(this._mappedType==x.prismaticPlane){let e=Tt.viewer.model.getNodeNetMatrix(this._mappedTargetComponent._nodeid).transform(this._prismaticPlaneTip),n=this._prismaticPlanePlane.distanceToPoint(e);n<0?await t._translate(n*this._helicalFactor):await t._translate(0)}else if(this._mappedTargetComponent._type==x.prismatic||this._mappedTargetComponent._type==x.mapped&&this._mappedTargetComponent._mappedType==x.prismatic){let e=this._mappedTargetComponent._currentPosition,n=Tt.viewer.model.getNodeMatrix(this._mappedTargetComponent._nodeid),o=this._mappedTargetComponent._parent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center),i=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center),r=Communicator.Point3.subtract(i,o).length();this._mappedTargetComponent._translate(r);let a=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center);this._mappedTargetComponent._translate(-r);let s=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center);Communicator.Point3.subtract(a,i).length()<Communicator.Point3.subtract(s,i).length()&&(r=-r),Tt.viewer.model.setNodeMatrix(this._mappedTargetComponent._nodeid,n),this._mappedType==x.revolute?(await t._rotate(r*this._helicalFactor,!0),t._currentAngle=r*this._helicalFactor):this._mappedType==x.prismatic?await t._translate(r*this._helicalFactor,!0):this._mappedType==x.belt&&await this.belt.move(r*this._helicalFactor),this._mappedTargetComponent._currentPosition=e}else this._mappedTargetComponent._behavior.getMovementType()!=x.revolute&&this._mappedTargetComponent._type!=x.mapped||(this._mappedType==x.revolute?(await t._rotate(this._mappedTargetComponent._currentAngle*this._helicalFactor,!0),t._currentAngle=this._mappedTargetComponent._currentAngle*this._helicalFactor):this._mappedType==x.prismatic?await t._translate(this._mappedTargetComponent._currentAngle*this._helicalFactor,!0):this._mappedType==x.belt&&await this.belt.move(this._mappedTargetComponent._currentAngle*this._helicalFactor))}setMappedType(t){this._mappedType=t}getMappedType(){return this._mappedType}createBelt(){this.belt=new o}setMappedTargetComponent(t){this._mappedTargetComponent=t}getMappedTargetComponent(){return this._mappedTargetComponent}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}setPrismaticPlanePlane(t){this._prismaticPlanePlane=t}getPrismaticPlanePlane(){return this._prismaticPlanePlane}setPrismaticPlaneTip(t){this._prismaticPlaneTip=t}getPrismaticPlaneTip(){return this._prismaticPlaneTip}getBelt(){return this.belt}}class c{constructor(t){this._component=t,this._type=x.helical,this._helicalFactor=1}getType(){return this._type}async fromJson(t,e){this._helicalFactor=t.helicalFactor}jsonFixup(){}toJson(t){t.helicalFactor=this._helicalFactor}getCurrentValue(){return this._component._currentPosition}set(t){this._component._translate(t)}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}getMovementType(){return x.prismatic}async execute(){let t=this._component,e=t._parent.transformlocalPointToWorldSpace(t._center),n=t.transformlocalPointToWorldSpace(t._center),o=Communicator.Point3.subtract(n,e).length();t._translate(o);let i=t.transformlocalPointToWorldSpace(t._center);t._translate(-o);let r=t.transformlocalPointToWorldSpace(t._center);Communicator.Point3.subtract(i,n).length()<Communicator.Point3.subtract(r,n).length()&&(t._translate(o),o=-o),t._rotate(o*this._helicalFactor,!0,!0)}}class p{constructor(t){this._component=t,this._type=x.prismaticAggregate,this._extraComponent1=null,this._extraComponent2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}async execute(){let t=this._component,e=Tt.viewer.model.getNodeMatrix(this._extraComponent1._nodeid),n=Tt.viewer.model.getNodeMatrix(this._extraComponent2._nodeid),o=Communicator.Matrix.multiply(e,n);await Tt.viewer.model.setNodeMatrix(t._nodeid,o)}}class _{constructor(t){this._component=t,this._type=x.revoluteSlide,this._extraComponent1=null,this._extraPivot1=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1)}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraPivot1=this._extraPivot1.toJson()}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}async execute(){let t=this._component,e=t._extraComponent1.transformlocalPointToWorldSpace(this._extraPivot1),n=t._parent.transformlocalPointToWorldSpace(t._center),o=t._parent.transformlocalPointToWorldSpace(this._extraPivot1),i=Communicator.Point3.subtract(o,n).normalize(),r=Communicator.Point3.subtract(e,n).normalize(),a=Communicator.Util.computeAngleBetweenVector(i,r);await t._rotate(a);let s=t.transformlocalPointToWorldSpace(this._extraPivot1),l=new Communicator.Point3(n.x+1e4*r.x,n.y+1e4*r.y,n.z+1e4*r.z),h=new Communicator.Point3(0,0,0);Communicator.Util.computePointToLineDistance(s,n,l,h)>1e-4&&await t._rotate(-a)}}class u{constructor(t){this._component=t,this._type=x.mate,this._extraComponent1=null,this._extraPivot1=null,this._extraComponent2=null,this._extraPivot2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1),this._extraPivot2=Communicator.Point3.fromJson(t.extraPivot2)}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id,t.extraPivot1=this._extraPivot1.toJson(),t.extraPivot2=this._extraPivot2.toJson()}getCurrentValue(){}set(t){}getMovementType(){return x.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}setExtraPivot2(t){this._extraPivot2=t}getExtraPivot2(){return this._extraPivot2}async execute(){let t=this._component,e=Communicator.Point3.subtract(this._extraPivot1,this._extraPivot2).length(),o=this._extraComponent1.transformlocalPointToWorldSpace(this._extraPivot1),i=this._extraComponent2.transformlocalPointToWorldSpace(this._extraPivot2),r=Communicator.Point3.subtract(o,i).length();if(Math.abs(e-r)>.001){let o,i;this._extraComponent2._touched?(o={j:this._extraComponent1,pivot:this._extraPivot1},i={j:this._extraComponent2,pivot:this._extraPivot2}):(i={j:this._extraComponent1,pivot:this._extraPivot1},o={j:this._extraComponent2,pivot:this._extraPivot2}),this._extraComponent1._touched=!1,this._extraComponent2._touched=!1;let r=i.j.transformlocalPointToWorldSpace(i.pivot),a=o.j.transformlocalPointToWorldSpace(o.pivot),s=o.j.transformlocalPointToWorldSpace(o.j._center),l=i.j.transformlocalPointToWorldSpace(t._center),h=i.j.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),m=Communicator.Point3.subtract(h,l).normalize(),c=t._axis,p=n.ComputeVectorToVectorRotationMatrix(m,new Communicator.Point3(0,0,1)),_=Communicator.Matrix.inverse(p),u=p.transform(r),d=e,g=p.transform(s),x=Communicator.Point3.subtract(o.j._center,o.pivot).length(),C=n.circleIntersection(u.x,u.y,d,g.x,g.y,x);C.p1.z=u.z,C.p2.z=u.z;let f=_.transform(C.p1),v=_.transform(C.p2),y=Communicator.Point3.subtract(f,a).length(),P=Communicator.Point3.subtract(v,a).length();y>P&&(f=v);let w=i.j.transformlocalPointToWorldSpace(o.pivot),M=Communicator.Point3.subtract(w,r).normalize(),T=Communicator.Point3.subtract(f,r).normalize(),b=Communicator.Util.computeAngleBetweenVector(M,T),N=n.computeOffaxisRotationMatrix(i.pivot,c,b),A=Communicator.Matrix.inverse(Tt.viewer.model.getNodeNetMatrix(Tt.viewer.model.getNodeParent(t._nodeid))),S=Communicator.Matrix.multiply(N,Tt.viewer.model.getNodeNetMatrix(i.j._nodeid)),H=Communicator.Matrix.multiply(S,A);await Tt.viewer.model.setNodeMatrix(t._nodeid,H);let I=t.transformlocalPointToWorldSpace(o.pivot);if(Communicator.Point3.subtract(I,f).length()>1e-4){N=n.computeOffaxisRotationMatrix(i.pivot,c,-b),S=Communicator.Matrix.multiply(N,Tt.viewer.model.getNodeNetMatrix(i.j._nodeid));let e=Communicator.Matrix.multiply(S,A);await Tt.viewer.model.setNodeMatrix(t._nodeid,e)}w=o.j._parent.transformlocalPointToWorldSpace(o.pivot),M=Communicator.Point3.subtract(w,s).normalize(),T=Communicator.Point3.subtract(f,s).normalize(),b=Communicator.Util.computeAngleBetweenVector(M,T),await o.j._rotate(b);let k=this._hierachy.getReferenceNodeNetMatrix(o.j);I=k.transform(o.pivot),await o.j._rotate(-b),k=this._hierachy.getReferenceNodeNetMatrix(o.j);let O=k.transform(o.pivot);y=Communicator.Point3.subtract(I,f).length(),P=Communicator.Point3.subtract(O,f).length(),y<P&&await o.j._rotate(b),await this.getHierachy().updateComponents()}}}const d={endRevolute:0,endPrismatic:1,endConnected:2,connector:3,centerRot:4,centerPrismatic:5};class g{constructor(t){this._component=t,this._type=x.pivotSystem,this._pivotType=d.centerRot,this._extraComponent1=null,this._extraComponent2=null,this._mappedComponent=null,this._helicalFactor=1,this._extraPivot1=null,this._associatedComponentHash=null,this._processed=!1,this._wasExecuted=!1}static clearExecutedSystems(t){if(t._systems)for(let e=0;e<t._systems.length;e++)t._systems[e]._behavior._wasExecuted=!1}static async executeUnexecutedSystems(t){if(t._systems)for(let e=0;e<t._systems.length;e++)t._systems[e]._behavior._wasExecuted||(t._systems[e]._touched=!0,await t._systems[e]._behavior.execute(t))}static rebuildAllHashes(t){for(let e in t.getComponentHash()){let n=t.getComponentById(e);n.getType()==x.pivotSystem&&(n._behavior._associatedComponentHash=null)}for(let e in t.getComponentHash()){let n=t.getComponentById(e);n.getType()==x.pivotSystem&&(n._behavior._extraComponent1&&n._behavior._extraComponent1._behavior._addToHash(n),n._behavior._extraComponent2&&n._behavior._extraComponent2._behavior._addToHash(n),n._behavior._mappedComponent&&n._behavior._mappedComponent._behavior._addToHash(n))}}static _gatherSystems(t,e,n){if(!e[t._id]&&(n.result||t._behavior._extraComponent1||(n.result=t),e[t._id]=!0,t._behavior._extraComponent1&&g._gatherSystems(t._behavior._extraComponent1,e,n),t._behavior._extraComponent2&&g._gatherSystems(t._behavior._extraComponent2,e,n),t._behavior._mappedComponent&&g._gatherSystems(t._behavior._mappedComponent,e,n),t._behavior._associatedComponentHash))for(let o in t._behavior._associatedComponentHash)g._gatherSystems(t._behavior._associatedComponentHash[o],e,n)}static findAllSystems(t){let e=[];t._systems=[];for(let n in t.getComponentHash()){let o=t.getComponentById(n);if(o.getType()==x.pivotSystem&&null==e[o._id]){let n={result:null};g._gatherSystems(o,e,n),t._systems.push(n.result)}}}getType(){return this._type}getPivotType(){return this._pivotType}setPivotType(t){this._pivotType=t}_addToHash(t){this._associatedComponentHash||(this._associatedComponentHash=[]),this._associatedComponentHash[t.getId()]=t}async fromJson(t,e){null!=t.pivotType&&(this._pivotType=t.pivotType),t.extraComponent1&&(this._extraComponent1=t.extraComponent1),t.extraComponent2&&(this._extraComponent2=t.extraComponent2),t.mappedComponent&&(this._mappedComponent=t.mappedComponent),t.extraPivot1&&(this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1)),t.helicalFactor&&(this._helicalFactor=t.helicalFactor)}jsonFixup(){this._extraComponent1&&(this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent1&&this._extraComponent1._behavior._addToHash(this._component)),this._extraComponent2&&(this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2],this._extraComponent2&&this._extraComponent2._behavior._addToHash(this._component)),this._mappedComponent&&(this._mappedComponent=this._component.getHierachy().getComponentHash()[this._mappedComponent],this._mappedComponent&&this._mappedComponent._behavior._addToHash(this._component))}toJson(t){t.pivotType=this._pivotType,this._extraComponent1&&(t.extraComponent1=this._extraComponent1._id),this._extraComponent2&&(t.extraComponent2=this._extraComponent2._id),this._mappedComponent&&(t.mappedComponent=this._mappedComponent._id),t.helicalFactor=this._helicalFactor,this._extraPivot1&&(t.extraPivot1=this._extraPivot1.toJson())}applyToModel(t){this._extraPivot1&&(this._extraPivot1=t.transform(this._extraPivot1))}getCurrentValue(){return this._pivotType!=d.endPrismatic&&this._pivotType!=d.centerPrismatic?this._component._currentAngle:this._component._currentPosition}set(t){this._pivotType!=d.endPrismatic&&this._pivotType!=d.centerPrismatic?this._component._rotate(t):this._component._translate(t)}getMovementType(){return this._extraComponent1&&this._extraComponent2?x.fixed:this._pivotType!=d.endPrismatic&&this._pivotType!=d.centerPrismatic?x.revolute:x.prismatic}async execute(){let t=this._component;if(t._touched){this._wasExecuted=!0;let e,o,i,r=[];if(r[t._id]=!0,this._pivotType==d.endPrismatic)e=this._extraComponent1.getWorldPlane(),o=this._extraComponent1.getXYMatrix();else if(this._pivotType==d.centerPrismatic)for(let t in this._associatedComponentHash){e=this._associatedComponentHash[t].getWorldPlane(),o=this._associatedComponentHash[t].getXYMatrix();break}else e=t.getWorldPlane(),o=t.getXYMatrix();if(i=Communicator.Matrix.inverse(o),this._associatedComponentHash){let n=null;for(let t in this._associatedComponentHash)this._associatedComponentHash[t]._behavior._pivotType==d.endConnected&&(n=this._associatedComponentHash[t]);if(n)this._resolveMultiComponent(n,e,o,i,r,!0);else for(let n in this._associatedComponentHash)this._associatedComponentHash[n]._behavior._mappedComponent==this._component?this._associatedComponentHash[n]._behavior._resolveMapped(this._component,e,o,i,r):this._associatedComponentHash[n]._behavior._resolve(t,e,o,i,r)}else if(this._extraComponent1){if(this._pivotType==d.endPrismatic){let r=t._parent.transformlocalPointToWorldSpace(t._center);r=n.closestPointOnPlane(e,r);let a=t._parent.transformlocalPointToWorldSpace(this._extraPivot1);a=n.closestPointOnPlane(e,a);let s=t.transformlocalPointToWorldSpace(this._extraPivot1);s=n.closestPointOnPlane(e,s);let l=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center);l=n.closestPointOnPlane(e,l);let h=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraPivot1);h=n.closestPointOnPlane(e,h);let m=this._circleIntersectionFromPoints(r,s,l,h,o,i),c=this._calculateAngle(a,m,r),p=this._findAngleSignMatrix(c,this._extraComponent1._axis,t._center,new Communicator.Matrix,this._extraPivot1,m,t,e),_=Tt.viewer.model.getNodeMatrix(t._nodeid),u=Communicator.Matrix.multiply(_,p);Tt.viewer.model.setNodeMatrix(t._nodeid,u)}this._extraComponent1._behavior._resolve(this._component,e,o,i,r)}this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(this._component,e,o,i,r),t._touched=!1}}_circleLineIntersectionFromPoints(t,e,o,i,r,a){let s=r.transform(t),l=r.transform(e),h=r.transform(o),m=r.transform(i),c=Communicator.Point3.subtract(l,s).length(),p=n.circleLineIntersection(c,s.x,s.y,h.x,h.y,m.x,m.y),_=new Communicator.Point3(p.x1,p.y1,s.z),u=new Communicator.Point3(p.x2,p.y2,s.z),d=a.transform(_),g=a.transform(u);return Communicator.Point3.subtract(d,i).length()<Communicator.Point3.subtract(g,i).length()?d:g}_circleIntersectionFromPoints(t,e,o,i,r,a){let s,l,h,m,c=r.transform(t),p=r.transform(e),_=r.transform(o),u=r.transform(i),d=Communicator.Point3.subtract(p,c).length(),g=Communicator.Point3.subtract(u,_).length(),x=n.circleIntersection(c.x,c.y,d,_.x,_.y,g);return x.p1&&(x.p1.z=c.z,s=a.transform(x.p1),h=Communicator.Point3.subtract(s,e).length()),x.p2&&(x.p2.z=_.z,l=a.transform(x.p2),m=Communicator.Point3.subtract(l,e).length()),h||m?h?m?h<m?s:l:s:l:(this._component._enforceLimits&&(this._component._hierachy._cantResolve=!0),e)}_calculateAngle(t,e,n){let o=Communicator.Point3.subtract(t,n).normalize(),i=Communicator.Point3.subtract(e,n).normalize();return Communicator.Util.computeAngleBetweenVector(o,i)}_findAngleSignMatrix(t,e,o,i,r,a,s,l){let h=this._component._calculateAngleRotMatrix(t,void 0,e,o),m=Communicator.Matrix.multiply(i,h),c=this._component.transformlocalPointToWorldSpaceWithMatrix(r,m);c=n.closestPointOnPlane(l,c);let p=Communicator.Point3.subtract(c,a).length(),_=this._component._calculateAngleRotMatrix(-t,void 0,e,o),u=Communicator.Matrix.multiply(i,_),d=this._component.transformlocalPointToWorldSpaceWithMatrix(r,u);return d=n.closestPointOnPlane(l,d),p<Communicator.Point3.subtract(d,a).length()?(s._currentAngle=t,m):(s._currentAngle=-t,u)}async _resolveMapped(t,e,n,o,i){let r=this._component;if(i[r._id])return;i[r._id]=!0,this._wasExecuted=!0;let a=0;a=null!=t._behavior._mappedComponent&&t._behavior._mappedComponent==r?1/t._behavior._helicalFactor:r._behavior._helicalFactor,r._rotate(t._currentAngle*a);for(let t in this._associatedComponentHash)this._associatedComponentHash[t]._behavior._mappedComponent==r?this._associatedComponentHash[t]._behavior._resolveMapped(r,e,n,o,i):this._associatedComponentHash[t]._behavior._resolve(r,e,n,o,i);this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(r,e,n,o,i)}async _resolveEndComponent(t,e,o,i,r){let a=this._component,s=a._parent.transformlocalPointToWorldSpace(a._center);s=n.closestPointOnPlane(e,s);let l=a._parent.transformlocalPointToWorldSpace(this._extraPivot1);l=n.closestPointOnPlane(e,l);let h=t.transformlocalPointToWorldSpace(this._extraPivot1);h=n.closestPointOnPlane(e,h);let m=this._calculateAngle(l,h,s);if(this._pivotType!=d.endPrismatic){let t=this._findAngleSignMatrix(m,a._axis,a._center,new Communicator.Matrix,this._extraPivot1,h,a,e);Tt.viewer.model.setNodeMatrix(a._nodeid,t)}else{let o=this._findAngleSignMatrix(m,t._axis,a._center,new Communicator.Matrix,this._extraPivot1,h,a,e);Tt.viewer.model.setNodeMatrix(a._nodeid,o),l=a.transformlocalPointToWorldSpace(this._extraPivot1),l=n.closestPointOnPlane(e,l);let i=Communicator.Point3.subtract(h,l).length();if(h.equalsWithTolerance(l,1e-4))return;let r=Communicator.Point3.subtract(h,l).normalize(),c=a._parent.transformPointToComponentSpace(s),p=a._parent.transformPointToComponentSpace(Communicator.Point3.add(s,r));r=Communicator.Point3.subtract(p,c).normalize();let _=i;Communicator.Point3.subtract(r,a._axis).length()<Communicator.Point3.subtract(new Communicator.Point3(-r.x,-r.y,-r.z),a._axis).length()?(null!=a._minLimit&&_<a._minLimit&&(_=a._minLimit,this._component._enforceLimits&&a._maxLimit&&(this._component._hierachy._cantResolve=!0)),null!=a._maxLimit&&_>a._maxLimit&&(_=a._maxLimit,this._component._enforceLimits&&a._maxLimit&&(this._component._hierachy._cantResolve=!0)),a._currentPosition=_,i=_):(_=-_,null!=a._minLimit&&_<a._minLimit&&(_=a._minLimit,this._component._enforceLimits&&a._maxLimit&&(this._component._hierachy._cantResolve=!0)),null!=a._maxLimit&&_>a._maxLimit&&(_=a._maxLimit,this._component._enforceLimits&&a._maxLimit&&(this._component._hierachy._cantResolve=!0)),a._currentPosition=_,i=-_);let u=new Communicator.Matrix;u=new Communicator.Matrix,u.setTranslationComponent(-a._center.x,-a._center.y,-a._center.z);let d=new Communicator.Matrix;d.setTranslationComponent(a._center.x,a._center.y,a._center.z);let g=new Communicator.Matrix;g.setTranslationComponent(r.x*i,r.y*i,r.z*i);let x=Communicator.Matrix.multiply(u,g),C=Communicator.Matrix.multiply(x,d),f=Tt.viewer.model.getNodeMatrix(a._nodeid),v=Communicator.Matrix.multiply(f,C);Tt.viewer.model.setNodeMatrix(a._nodeid,v)}}async _resolveConnectorComponent(t,e,o,i,r){let a,s,l,h=this._component;this._extraComponent1.getId()==t.getId()?(a=h._center,l=this._extraComponent2,s=this._extraPivot1):(a=this._extraPivot1,l=this._extraComponent1,s=h._center);let m=t.transformlocalPointToWorldSpace(a),c=h._parent.transformlocalPointToWorldSpace(a),p=l._parent.transformlocalPointToWorldSpace(s),_=l._parent.transformlocalPointToWorldSpace(l._center);m=n.closestPointOnPlane(e,m),c=n.closestPointOnPlane(e,c),p=n.closestPointOnPlane(e,p),_=n.closestPointOnPlane(e,_);let u,g=h._parent.transformPointToComponentSpace(m),x=h._parent.transformPointToComponentSpace(c),C=Communicator.Point3.subtract(g,x),f=new Communicator.Matrix;f.setTranslationComponent(C.x,C.y,C.z),Tt.viewer.model.setNodeMatrix(h._nodeid,f);let v=h.transformlocalPointToWorldSpace(s);if(v=n.closestPointOnPlane(e,v),l._behavior._pivotType==d.centerPrismatic){let t=h._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(s,l._axis));t=n.closestPointOnPlane(e,t),u=this._circleLineIntersectionFromPoints(m,v,p,t,o,i),u=n.closestPointOnPlane(e,u)}else r[l._id]?(u=l.transformlocalPointToWorldSpace(s),u=n.closestPointOnPlane(e,u)):u=this._circleIntersectionFromPoints(m,v,_,p,o,i);let y=this._calculateAngle(v,u,m),P=this._findAngleSignMatrix(y,h._axis,g,f,s,u,h,e);Tt.viewer.model.setNodeMatrix(h._nodeid,P),l._behavior._resolve(h,e,o,i,r)}async _resolveMultiComponent(t,e,o,i,r,a){let s,l,h=this._component,m=h._parent.transformlocalPointToWorldSpace(h._center);if(m=n.closestPointOnPlane(e,m),t._behavior._extraComponent1==h)if(t._behavior._extraComponent2)s=t._center;else if(s=t._behavior._extraPivot1,t._behavior._pivotType!=d.endPrismatic){let r=t.transformlocalPointToWorldSpace(s);r=n.closestPointOnPlane(e,r);let m=t.transformlocalPointToWorldSpace(t._center);m=n.closestPointOnPlane(e,m);let c=h.transformlocalPointToWorldSpace(h._center);c=n.closestPointOnPlane(e,c);let p=h.transformlocalPointToWorldSpace(s);p=n.closestPointOnPlane(e,p),l=a?this._circleIntersectionFromPoints(c,p,m,r,o,i):this._circleLineIntersectionFromPoints(c,p,m,r,o,i)}else l=t.transformlocalPointToWorldSpace(s),l=n.closestPointOnPlane(e,l);else s=t._behavior._extraPivot1;let c,p=h._parent.transformlocalPointToWorldSpace(s);if(p=n.closestPointOnPlane(e,p),l?c=l:(c=t.transformlocalPointToWorldSpace(s),c=n.closestPointOnPlane(e,c)),h._behavior._pivotType==d.centerPrismatic){let t=Communicator.Point3.subtract(c,p).length(),e=t;h._translate(t);let n=h.transformlocalPointToWorldSpace(p);h._translate(-t),e=-t;let o=h.transformlocalPointToWorldSpace(p);Communicator.Point3.subtract(n,c).length()<Communicator.Point3.subtract(o,c).length()&&(h._translate(t),e=t),this._component._enforceLimits&&h._maxLimit&&(e<h._minLimit||e>h._maxLimit)&&(this._component._hierachy._cantResolve=!0)}else{let t=this._calculateAngle(p,c,m),n=h._parent.transformPointToComponentSpace(m),o=h._parent.transformPointToComponentSpace(p),i=this._findAngleSignMatrix(t,h._axis,n,new Communicator.Matrix,o,c,h,e);Tt.viewer.model.setNodeMatrix(h._nodeid,i)}a&&(t=null);for(let n in this._associatedComponentHash)this._associatedComponentHash[n]!=t&&(this._associatedComponentHash[n]._behavior._mappedComponent==h?this._associatedComponentHash[n]._behavior._resolveMapped(h,e,o,i,r):this._associatedComponentHash[n]._behavior._resolve(h,e,o,i,r));this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(h,e,o,i,r)}async _resolve(t,e,n,o,i){i[this._component._id]||(i[this._component._id]=!0,this._wasExecuted=!0,this._pivotType==d.connector?this._resolveConnectorComponent(t,e,n,o,i):this._pivotType==d.endRevolute||this._pivotType==d.endPrismatic||this._pivotType==d.endConnected?this._resolveEndComponent(t,e,n,o,i):this._resolveMultiComponent(t,e,n,o,i))}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getMappedComponent(){return this._mappedComponent}setMappedComponent(t){this._mappedComponent=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}}const x={revolute:0,prismatic:1,fixed:2,prismaticAggregate:3,prismaticTriangle:4,helical:5,mapped:6,pistonController:7,prismaticPlane:8,belt:9,mate:10,revoluteSlide:11,target:12,pivotSystem:13};class C{constructor(t,e){this._hierachy=e,this._id=e._highestId++,this._type=x.revolute,this._behavior=new i(this),this._children=[],this._parent=t,this._minLimit=void 0,this._maxLimit=void 0,this._nodeid=-1,this._center=new Communicator.Point3(0,0,0),this._axis=new Communicator.Point3(1,0,0),this._currentAngle=0,this._currentPosition=0,this._referenceNodes=[],this._parentMatrix=new Communicator.Matrix,this._extraComponent1=null,this._extraComponent2=null,this._reference=!0,this._touched=!1,this._animations=[],this._activeAnimation=!1,this._enforceLimits=!0}initialize(t,e){this._reference=e,this._parent?this._nodeid=Tt.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=Tt.viewer.model.createNode(this._hierachy.getRootNode(),"rootComponent"),this._parentMatrix=Tt.viewer.model.getNodeNetMatrix(Tt.viewer.model.getNodeParent(t[0]));for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:Tt.viewer.model.getNodeNetMatrix(t[e]).copy()})}getId(){return this._id}setType(t){this._type!=t&&(this._type=t,this._type==x.revolute?this._behavior=new i(this):this._type==x.prismatic?this._behavior=new r(this):this._type==x.pistonController?this._behavior=new a(this):this._type==x.fixed?this._behavior=new s(this):this._type==x.target?this._behavior=new l(this):this._type==x.prismaticTriangle?this._behavior=new h(this):this._type==x.mapped?this._behavior=new m(this):this._type==x.helical?this._behavior=new c(this):this._type==x.revoluteSlide?this._behavior=new _(this):this._type==x.prismaticAggregate?this._behavior=new p(this):this._type==x.mate?this._behavior=new u(this):this._type==x.pivotSystem?this._behavior=new g(this):this._behavior=Tt.getCustomTypeCallback()(this,t))}getType(){return this._behavior?this._behavior.getType():this._type}setBehavior(t){this._behavior=t}getBehavior(){return this._behavior}setParent(t){this._parent=t}getParent(){return this._parent}getChildren(){return this._children}getChildByIndex(t){return this._children[t]}setNodeId(t){this._nodeid=t}getNodeId(){return this._nodeid}getHierachy(){return this._hierachy}setCenter(t){this._center=t}getCenter(){return this._center}setAxis(t){this._axis=t}getAxis(){return this._axis}getCurrentValue(){if(this._behavior)return this._behavior.getCurrentValue()}getReferenceNodes(){return this._referenceNodes}getParentMatrix(){return this._parentMatrix}setIsReference(t){this._reference=t}getIsReference(){return this._reference}getAnimations(){return this._animations}getAnimationActive(){return this._activeAnimation}setAnimationActive(t){this._activeAnimation=t}getAnimationByIndex(t){return this._animations[t]}setMinLimit(t){this._minLimit=t}getMinLimit(){return this._minLimit}setMaxLimit(t){this._maxLimit=t}setEnforceLimits(t){this._enforceLimits=t}getEnforceLimits(){return this._enforceLimits}getMaxLimit(){return this._maxLimit}set(t){this._hierachy._touchedRewind={nodeid:this._nodeid,matrix:Tt.viewer.model.getNodeMatrix(this._nodeid).copy()},this._behavior.set(t),this._touched=!0}toJson(){let t=[];for(let e=0;e<this._children.length;e++)t.push(this._children[e].toJson());let e=[];if(this.getType()==x.mapped&&this._behavior._mappedType==x.belt);else for(let t=0;t<this._referenceNodes.length;t++)e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});let n={id:this._id,reference:this._reference,type:this.getType(),center:this._center.toJson(),axis:this._axis.toJson(),minLimit:this._minLimit,maxLimit:this._maxLimit,children:t,referenceNodes:e,parentMatrix:this._parentMatrix.toJson(),enforceLimits:this._enforceLimits};this._behavior&&this._behavior.toJson(n),n.animations=[];for(let t=0;t<this._animations.length;t++)n.animations.push(this._animations[t]);return n}async fromJson(t,e){if(this._minLimit=t.minLimit,this._maxLimit=t.maxLimit,this._reference=t.reference,this._center=Communicator.Point3.fromJson(t.center),null!=t.id&&(this._id=t.id,this._id>=this._hierachy._highestId&&(this._hierachy._highestId=this._id+1)),null==e){let e=Communicator.Point3.fromJson(t.axis);this._axis=Communicator.Point3.subtract(e,this._center).normalize(),isNaN(this._axis.x)&&(this._axis=new Communicator.Point3(1,0,0))}else this._axis=Communicator.Point3.fromJson(t.axis);null!=t.enforceLimits&&(this._enforceLimits=t.enforceLimits),this.setType(t.type),this._behavior&&this._behavior.fromJson(t,e),this._parentMatrix=Communicator.Matrix.fromJson(t.parentMatrix),this._hierachy.getComponentHash()[this._id]=this,this._parent?this._nodeid=Tt.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=Tt.viewer.model.createNode(this._hierachy.getRootNode(),"rootComponent");for(let e=0;e<t.referenceNodes.length;e++)this._referenceNodes.push({nodeid:t.referenceNodes[e].nodeid,matrix:Communicator.Matrix.fromJson(t.referenceNodes[e].matrix)}),this._hierachy._componentNodeidHash[t.referenceNodes[e].nodeid]=this;for(let n=0;n<t.children.length;n++){let o=new C(this,this._hierachy);o.fromJson(t.children[n],e),this._children.push(o)}if(t.animations)for(let e=0;e<t.animations.length;e++)this._animations.push(t.animations[e])}addAnimation(t){this._animations.push(t)}removeAnimation(t){for(let e=0;e<this._animations.length;e++)if(this._animations[e]==t)return void this._animations.splice(e,1)}removeAnimationRecursive(t){for(let e=0;e<this._children.length;e++)this._children[e].removeAnimationRecursive(t);this.removeAnimation(t)}animToJson(t){for(let e=0;e<this._children.length;e++)this._children[e].animToJson(t);for(let e=0;e<this._animations.length;e++)t[this._animations[e]]=!0}updateReferenceNodes(t){for(let t=0;t<this._referenceNodes.length;t++)delete this._hierachy._componentNodeidHash[this._referenceNodes[t].nodeid];this._referenceNodes=[];for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:Tt.viewer.model.getNodeNetMatrix(t[e]).copy()}),this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid]=this}removeReferenceNodes(t){for(let e=0;e<this._referenceNodes.length;e++)for(let n=0;n<t.length;n++)if(this._referenceNodes[e].nodeid==t[n]){delete this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid],this._referenceNodes.splice(e,1),e--;break}}transformPointToComponentSpace(t){let e=this._hierachy.getReferenceNodeNetMatrix(this);return Communicator.Matrix.inverse(e).transform(t)}transformlocalPointToWorldSpace(t){return this._hierachy.getReferenceNodeNetMatrix(this).transform(t)}transformlocalPointToWorldSpaceWithMatrix(t,e){let n=this._hierachy.getReferenceNodeNetMatrix(this._parent);return n=Communicator.Matrix.multiply(e,n),n.transform(t)}_calculateAngleRotMatrix(t,e,n,o){let i,r,a=new Communicator.Matrix,s=new Communicator.Matrix;i=n||this._axis,r=o||this._center,s=new Communicator.Matrix,s.setTranslationComponent(-r.x,-r.y,-r.z);let l=new Communicator.Matrix;l.setTranslationComponent(r.x,r.y,r.z),Communicator.Util.computeOffaxisRotation(i,t,a);let h=Communicator.Matrix.multiply(s,a),m=Communicator.Matrix.multiply(h,l);if(null!=e){let t=Tt.viewer.model.getNodeMatrix(this._nodeid);return Communicator.Matrix.multiply(t,m)}return m}_rotate(t,e,n){n?(null!=this._minLimit&&this._currentAngle+t<this._minLimit&&(t=this._minLimit-this._currentAngle),null!=this._maxLimit&&this._currentAngle+t>this._maxLimit&&(t=this._maxLimit-this._currentAngle),this._currentAngle+=t):(this._currentAngle=t,null!=this._minLimit&&this._currentAngle<this._minLimit&&(this._currentAngle=this._minLimit,t=this._currentAngle),null!=this._maxLimit&&this._currentAngle>this._maxLimit&&(this._currentAngle=this._maxLimit,t=this._currentAngle));let o=this._calculateAngleRotMatrix(t,n);Tt.viewer.model.setNodeMatrix(this._nodeid,o)}_translate(t){null!=this._minLimit&&t<this._minLimit&&(t=this._minLimit),null!=this._maxLimit&&t>this._maxLimit&&(t=this._maxLimit),this._currentPosition=t;let e=new Communicator.Matrix,n=this._axis;e=new Communicator.Matrix,e.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let o=new Communicator.Matrix;o.setTranslationComponent(this._center.x,this._center.y,this._center.z);let i=new Communicator.Matrix;i.setTranslationComponent(n.x*t,n.y*t,n.z*t);let r=Communicator.Matrix.multiply(e,i),a=Communicator.Matrix.multiply(r,o);Tt.viewer.model.setNodeMatrix(this._nodeid,a)}async calculateMatrixFromHandleMatrix(t){let e;if(this._reference){let n,o=Communicator.Matrix.multiply(t,this._parentMatrix),i=Communicator.Matrix.inverse(this._referenceNodes[0].matrix),r=Communicator.Matrix.multiply(i,o);n=this._parent._parent?this._hierachy.getReferenceNodeNetMatrix(this._parent):new Communicator.Matrix,i=Communicator.Matrix.inverse(n),e=Communicator.Matrix.multiply(r,i)}else{let n=Communicator.Matrix.multiply(t,this._parentMatrix),o=Communicator.Matrix.inverse(this._referenceNodes[0].matrix);e=Communicator.Matrix.multiply(o,n)}if(this._behavior.getMovementType()==x.revolute){let t=Tt.viewer.model.getNodeMatrix(this._nodeid),o=this._axis,i=Communicator.Point3.cross(new Communicator.Point3(1,0,0),o);i.length()<1e-5&&(i=Communicator.Point3.cross(new Communicator.Point3(0,1,0),o));let r=Communicator.Point3.add(i,this._center),a=t.transform(component._center),s=t.transform(r),l=(e.transform(this._center),e.transform(r)),h=Communicator.Point3.subtract(s,a).normalize(),m=Communicator.Point3.subtract(l,a).normalize(),c=n.signedAngle(h,m,o);await this._rotate(c,!0,!0)}else{let t=Tt.viewer.model.getNodeNetMatrix(this._parent._nodeid);await Tt.viewer.model.setNodeMatrix(this._nodeid,e);let n=Tt.viewer.model.getNodeNetMatrix(this._nodeid),o=t.transform(this._center),i=n.transform(this._center),r=Communicator.Point3.subtract(i,o).length();await this._translate(r),o=Tt.viewer.model.getNodeNetMatrix(this._nodeid).transform(this._center),i=Communicator.Matrix.multiply(t,e).transform(this._center),Communicator.Point3.subtract(i,o).length()>1e-4&&await this._translate(-r)}this._touched=!0}setParametersFromHandle(){if(Tt.handlePlacementOperator.getPosition()){let t=Tt.handlePlacementOperator.getPosition(),e=Tt.handlePlacementOperator.getAxis();if(!e)return;let n=this._hierachy.getReferenceNodeNetMatrix(this),o=Communicator.Matrix.inverse(n),i=o.transform(t),r=new Communicator.Point3(t.x+e.x,t.y+e.y,t.z+e.z),a=o.transform(r);this.setCenter(i),this.setAxis(Communicator.Point3.subtract(a,i).normalize())}}selectReferenceNodes(){Tt.viewer.selectionManager.clear();let t=[];for(let e=0;e<this._referenceNodes.length;e++)t.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[e].nodeid));Tt.viewer.selectionManager.add(t)}showHandles(t,e,n){let o=Tt.handlePlacementOperator,i=this._hierachy.getReferenceNodeNetMatrix(this),r=i.transform(this._center),a=i.transform(Communicator.Point3.add(this._center,this._axis)),s=Communicator.Point3.subtract(a,r);n&&(r=n);let l=[];Tt.viewer.selectionManager.clear();let h=[];for(let t=0;t<this._referenceNodes.length;t++)h.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[t].nodeid)),l.push(this._referenceNodes[t].nodeid);if(Tt.viewer.selectionManager.add(h),null!=e&&(l=[],l.push(e)),o._addAxisTranslationHandle(r,s,l),o._addAxisTranslationHandle(r,s.copy().scale(-1),l),this._behavior.getMovementType()!=x.prismatic&&o._addAxisRotationHandle(r,s,l),t||this._fixedAxis){let t;this._fixedAxis?t=this._fixedAxisTarget.copy():(t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),s),t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),s))),o._addAxisTranslationHandle(r,t,l),Tt.getHandleOperator().setSecondAxis(t.copy())}Tt.getHandleOperator().setAxis(s.copy())}async calculateGradient(){let t,e=this._currentAngle,n=this._currentPosition,o=this._hierachy.distanceFromIKTarget();return this._behavior.getMovementType()==x.revolute?(await this._rotate(this._currentAngle+this._hierachy._ikSamplingDistance,!0),t=(this._hierachy.distanceFromIKTarget()-o)/this._hierachy._ikSamplingDistance):(await this._translate(this._currentPosition+this._hierachy._ikSamplingDistanceTranslation),t=(this._hierachy.distanceFromIKTarget()-o)/this._hierachy._ikSamplingDistanceTranslation),this._behavior.getMovementType()==x.revolute?await this._rotate(e):await this._translate(n),t}async update(t){this._behavior.getMovementType()==x.revolute?await this._rotate(this._currentAngle-this._hierachy._ikLearningRate*t):await this._translate(this._currentPosition-this._hierachy._ikLearningRate*t)}reset(){this._behavior.set(0)}delete(){if(this._parent){delete this._hierachy.getComponentHash()[this._id];for(let t=0;t<this._children.length;t++)this._children[t]._parent=this._parent,this._parent._children.push(this._children[t]);for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}}}moveup(){if(this._parent){for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}this._parent._parent._children.push(this)}}async _execute(){this._behavior&&await this._behavior.execute(this)}async _updateReferenceNodeMatrices(){if(this._reference)if(this._parent&&0==this._parent._reference)for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,Tt.viewer.model.getNodeMatrix(this._nodeid)),n=Communicator.Matrix.multiply(e,Tt.viewer.model.getNodeMatrix(this._parent._nodeid)),o=Communicator.Matrix.inverse(this._parent._parentMatrix),i=Communicator.Matrix.multiply(n,o);Tt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,i)}else for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,this._hierachy.getReferenceNodeNetMatrix(this)),n=Communicator.Matrix.inverse(this._parentMatrix),o=Communicator.Matrix.multiply(e,n);Tt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,o)}else for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,Tt.viewer.model.getNodeMatrix(this._nodeid)),n=Communicator.Matrix.inverse(this._parentMatrix),o=Communicator.Matrix.multiply(e,n);Tt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,o)}}getWorldPlane(){let t=this._parent.transformlocalPointToWorldSpace(this._center),e=this._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._center,this._axis));return e=Communicator.Point3.subtract(e,t).normalize(),Communicator.Plane.createFromPointAndNormal(t,e)}getXYMatrix(){let t=this._parent.transformlocalPointToWorldSpace(this._center),e=this._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._center,this._axis));return e=Communicator.Point3.subtract(e,t).normalize(),n.ComputeVectorToVectorRotationMatrix(e,new Communicator.Point3(0,0,1))}}var f={update:null,begin:null,loopBegin:null,changeBegin:null,change:null,changeComplete:null,loopComplete:null,complete:null,loop:1,direction:"normal",autoplay:!0,timelineOffset:0},v={duration:1e3,delay:0,endDelay:0,easing:"easeOutElastic(1, .5)",round:0},y=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],P={CSS:{},springs:{}};function w(t,e,n){return Math.min(Math.max(t,e),n)}function M(t,e){return t.indexOf(e)>-1}function T(t,e){return t.apply(null,e)}var b={arr:function(t){return Array.isArray(t)},obj:function(t){return M(Object.prototype.toString.call(t),"Object")},pth:function(t){return b.obj(t)&&t.hasOwnProperty("totalLength")},svg:function(t){return t instanceof SVGElement},inp:function(t){return t instanceof HTMLInputElement},dom:function(t){return t.nodeType||b.svg(t)},str:function(t){return"string"==typeof t},fnc:function(t){return"function"==typeof t},und:function(t){return void 0===t},nil:function(t){return b.und(t)||null===t},hex:function(t){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)},rgb:function(t){return/^rgb/.test(t)},hsl:function(t){return/^hsl/.test(t)},col:function(t){return b.hex(t)||b.rgb(t)||b.hsl(t)},key:function(t){return!f.hasOwnProperty(t)&&!v.hasOwnProperty(t)&&"targets"!==t&&"keyframes"!==t}};function N(t){var e=/\(([^)]+)\)/.exec(t);return e?e[1].split(",").map((function(t){return parseFloat(t)})):[]}function A(t,e){var n=N(t),o=w(b.und(n[0])?1:n[0],.1,100),i=w(b.und(n[1])?100:n[1],.1,100),r=w(b.und(n[2])?10:n[2],.1,100),a=w(b.und(n[3])?0:n[3],.1,100),s=Math.sqrt(i/o),l=r/(2*Math.sqrt(i*o)),h=l<1?s*Math.sqrt(1-l*l):0,m=l<1?(l*s-a)/h:-a+s;function c(t){var n=e?e*t/1e3:t;return n=l<1?Math.exp(-n*l*s)*(1*Math.cos(h*n)+m*Math.sin(h*n)):(1+m*n)*Math.exp(-n*s),0===t||1===t?t:1-n}return e?c:function(){var e=P.springs[t];if(e)return e;for(var n=1/6,o=0,i=0;;)if(1===c(o+=n)){if(++i>=16)break}else i=0;var r=o*n*1e3;return P.springs[t]=r,r}}function S(t){return void 0===t&&(t=10),function(e){return Math.ceil(w(e,1e-6,1)*t)*(1/t)}}var H,I,k=function(){var t=.1;function e(t,e){return 1-3*e+3*t}function n(t,e){return 3*e-6*t}function o(t){return 3*t}function i(t,i,r){return((e(i,r)*t+n(i,r))*t+o(i))*t}function r(t,i,r){return 3*e(i,r)*t*t+2*n(i,r)*t+o(i)}return function(e,n,o,a){if(0<=e&&e<=1&&0<=o&&o<=1){var s=new Float32Array(11);if(e!==n||o!==a)for(var l=0;l<11;++l)s[l]=i(l*t,e,o);return function(l){return e===n&&o===a||0===l||1===l?l:i(function(n){for(var a=0,l=1;10!==l&&s[l]<=n;++l)a+=t;--l;var h=a+(n-s[l])/(s[l+1]-s[l])*t,m=r(h,e,o);return m>=.001?function(t,e,n,o){for(var a=0;a<4;++a){var s=r(e,n,o);if(0===s)return e;e-=(i(e,n,o)-t)/s}return e}(n,h,e,o):0===m?h:function(t,e,n,o,r){var a,s,l=0;do{(a=i(s=e+(n-e)/2,o,r)-t)>0?n=s:e=s}while(Math.abs(a)>1e-7&&++l<10);return s}(n,a,a+t,e,o)}(l),n,a)}}}}(),O=(H={linear:function(){return function(t){return t}}},I={Sine:function(){return function(t){return 1-Math.cos(t*Math.PI/2)}},Circ:function(){return function(t){return 1-Math.sqrt(1-t*t)}},Back:function(){return function(t){return t*t*(3*t-2)}},Bounce:function(){return function(t){for(var e,n=4;t<((e=Math.pow(2,--n))-1)/11;);return 1/Math.pow(4,3-n)-7.5625*Math.pow((3*e-2)/22-t,2)}},Elastic:function(t,e){void 0===t&&(t=1),void 0===e&&(e=.5);var n=w(t,1,10),o=w(e,.1,2);return function(t){return 0===t||1===t?t:-n*Math.pow(2,10*(t-1))*Math.sin((t-1-o/(2*Math.PI)*Math.asin(1/n))*(2*Math.PI)/o)}}},["Quad","Cubic","Quart","Quint","Expo"].forEach((function(t,e){I[t]=function(){return function(t){return Math.pow(t,e+2)}}})),Object.keys(I).forEach((function(t){var e=I[t];H["easeIn"+t]=e,H["easeOut"+t]=function(t,n){return function(o){return 1-e(t,n)(1-o)}},H["easeInOut"+t]=function(t,n){return function(o){return o<.5?e(t,n)(2*o)/2:1-e(t,n)(-2*o+2)/2}},H["easeOutIn"+t]=function(t,n){return function(o){return o<.5?(1-e(t,n)(1-2*o))/2:(e(t,n)(2*o-1)+1)/2}}})),H);function L(t,e){if(b.fnc(t))return t;var n=t.split("(")[0],o=O[n],i=N(t);switch(n){case"spring":return A(t,e);case"cubicBezier":return T(k,i);case"steps":return T(S,i);default:return T(o,i)}}function z(t){try{return document.querySelectorAll(t)}catch(t){return}}function R(t,e){for(var n=t.length,o=arguments.length>=2?arguments[1]:void 0,i=[],r=0;r<n;r++)if(r in t){var a=t[r];e.call(o,a,r,t)&&i.push(a)}return i}function F(t){return t.reduce((function(t,e){return t.concat(b.arr(e)?F(e):e)}),[])}function W(t){return b.arr(t)?t:(b.str(t)&&(t=z(t)||t),t instanceof NodeList||t instanceof HTMLCollection?[].slice.call(t):[t])}function J(t,e){return t.some((function(t){return t===e}))}function D(t){var e={};for(var n in t)e[n]=t[n];return e}function E(t,e){var n=D(t);for(var o in t)n[o]=e.hasOwnProperty(o)?e[o]:t[o];return n}function B(t,e){var n=D(t);for(var o in e)n[o]=b.und(t[o])?e[o]:t[o];return n}function j(t){var e=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?(%|px|pt|em|rem|in|cm|mm|ex|ch|pc|vw|vh|vmin|vmax|deg|rad|turn)?$/.exec(t);if(e)return e[1]}function V(t,e){return b.fnc(t)?t(e.target,e.id,e.total):t}function q(t,e){return t.getAttribute(e)}function G(t,e,n){if(J([n,"deg","rad","turn"],j(e)))return e;var o=P.CSS[e+n];if(!b.und(o))return o;var i=document.createElement(t.tagName),r=t.parentNode&&t.parentNode!==document?t.parentNode:document.body;r.appendChild(i),i.style.position="absolute",i.style.width=100+n;var a=100/i.offsetWidth;r.removeChild(i);var s=a*parseFloat(e);return P.CSS[e+n]=s,s}function U(t,e,n){if(e in t.style){var o=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),i=t.style[e]||getComputedStyle(t).getPropertyValue(o)||"0";return n?G(t,i,n):i}}function K(t,e){return b.dom(t)&&!b.inp(t)&&(!b.nil(q(t,e))||b.svg(t)&&t[e])?"attribute":b.dom(t)&&J(y,e)?"transform":b.dom(t)&&"transform"!==e&&U(t,e)?"css":null!=t[e]?"object":void 0}function X(t){if(b.dom(t)){for(var e,n=t.style.transform||"",o=/(\w+)\(([^)]*)\)/g,i=new Map;e=o.exec(n);)i.set(e[1],e[2]);return i}}function Y(t,e,n,o){switch(K(t,e)){case"transform":return function(t,e,n,o){var i=M(e,"scale")?1:0+function(t){return M(t,"translate")||"perspective"===t?"px":M(t,"rotate")||M(t,"skew")?"deg":void 0}(e),r=X(t).get(e)||i;return n&&(n.transforms.list.set(e,r),n.transforms.last=e),o?G(t,r,o):r}(t,e,o,n);case"css":return U(t,e,n);case"attribute":return q(t,e);default:return t[e]||0}}function $(t,e){var n=/^(\*=|\+=|-=)/.exec(t);if(!n)return t;var o=j(t)||0,i=parseFloat(e),r=parseFloat(t.replace(n[0],""));switch(n[0][0]){case"+":return i+r+o;case"-":return i-r+o;case"*":return i*r+o}}function Q(t,e){if(b.col(t))return function(t){return b.rgb(t)?(n=/rgb\((\d+,\s*[\d]+,\s*[\d]+)\)/g.exec(e=t))?"rgba("+n[1]+",1)":e:b.hex(t)?function(t){var e=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,n,o){return e+e+n+n+o+o})),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return"rgba("+parseInt(n[1],16)+","+parseInt(n[2],16)+","+parseInt(n[3],16)+",1)"}(t):b.hsl(t)?function(t){var e,n,o,i=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(t)||/hsla\((\d+),\s*([\d.]+)%,\s*([\d.]+)%,\s*([\d.]+)\)/g.exec(t),r=parseInt(i[1],10)/360,a=parseInt(i[2],10)/100,s=parseInt(i[3],10)/100,l=i[4]||1;function h(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t}if(0==a)e=n=o=s;else{var m=s<.5?s*(1+a):s+a-s*a,c=2*s-m;e=h(c,m,r+1/3),n=h(c,m,r),o=h(c,m,r-1/3)}return"rgba("+255*e+","+255*n+","+255*o+","+l+")"}(t):void 0;var e,n}(t);if(/\s/g.test(t))return t;var n=j(t),o=n?t.substr(0,t.length-n.length):t;return e?o+e:o}function Z(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function tt(t){for(var e,n=t.points,o=0,i=0;i<n.numberOfItems;i++){var r=n.getItem(i);i>0&&(o+=Z(e,r)),e=r}return o}function et(t){if(t.getTotalLength)return t.getTotalLength();switch(t.tagName.toLowerCase()){case"circle":return function(t){return 2*Math.PI*q(t,"r")}(t);case"rect":return function(t){return 2*q(t,"width")+2*q(t,"height")}(t);case"line":return function(t){return Z({x:q(t,"x1"),y:q(t,"y1")},{x:q(t,"x2"),y:q(t,"y2")})}(t);case"polyline":return tt(t);case"polygon":return function(t){var e=t.points;return tt(t)+Z(e.getItem(e.numberOfItems-1),e.getItem(0))}(t)}}function nt(t,e){var n=e||{},o=n.el||function(t){for(var e=t.parentNode;b.svg(e)&&b.svg(e.parentNode);)e=e.parentNode;return e}(t),i=o.getBoundingClientRect(),r=q(o,"viewBox"),a=i.width,s=i.height,l=n.viewBox||(r?r.split(" "):[0,0,a,s]);return{el:o,viewBox:l,x:l[0]/1,y:l[1]/1,w:a,h:s,vW:l[2],vH:l[3]}}function ot(t,e,n){function o(n){void 0===n&&(n=0);var o=e+n>=1?e+n:0;return t.el.getPointAtLength(o)}var i=nt(t.el,t.svg),r=o(),a=o(-1),s=o(1),l=n?1:i.w/i.vW,h=n?1:i.h/i.vH;switch(t.property){case"x":return(r.x-i.x)*l;case"y":return(r.y-i.y)*h;case"angle":return 180*Math.atan2(s.y-a.y,s.x-a.x)/Math.PI}}function it(t,e){var n=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?/g,o=Q(b.pth(t)?t.totalLength:t,e)+"";return{original:o,numbers:o.match(n)?o.match(n).map(Number):[0],strings:b.str(t)||e?o.split(n):[]}}function rt(t){return R(t?F(b.arr(t)?t.map(W):W(t)):[],(function(t,e,n){return n.indexOf(t)===e}))}function at(t){var e=rt(t);return e.map((function(t,n){return{target:t,id:n,total:e.length,transforms:{list:X(t)}}}))}function st(t,e){var n=D(e);if(/^spring/.test(n.easing)&&(n.duration=A(n.easing)),b.arr(t)){var o=t.length;2!==o||b.obj(t[0])?b.fnc(e.duration)||(n.duration=e.duration/o):t={value:t}}var i=b.arr(t)?t:[t];return i.map((function(t,n){var o=b.obj(t)&&!b.pth(t)?t:{value:t};return b.und(o.delay)&&(o.delay=n?0:e.delay),b.und(o.endDelay)&&(o.endDelay=n===i.length-1?e.endDelay:0),o})).map((function(t){return B(t,n)}))}var lt={css:function(t,e,n){return t.style[e]=n},attribute:function(t,e,n){return t.setAttribute(e,n)},object:function(t,e,n){return t[e]=n},transform:function(t,e,n,o,i){if(o.list.set(e,n),e===o.last||i){var r="";o.list.forEach((function(t,e){r+=e+"("+t+") "})),t.style.transform=r}}};function ht(t,e){at(t).forEach((function(t){for(var n in e){var o=V(e[n],t),i=t.target,r=j(o),a=Y(i,n,r,t),s=$(Q(o,r||j(a)),a),l=K(i,n);lt[l](i,n,s,t.transforms,!0)}}))}function mt(t,e){return R(F(t.map((function(t){return e.map((function(e){return function(t,e){var n=K(t.target,e.name);if(n){var o=function(t,e){var n;return t.tweens.map((function(o){var i=function(t,e){var n={};for(var o in t){var i=V(t[o],e);b.arr(i)&&1===(i=i.map((function(t){return V(t,e)}))).length&&(i=i[0]),n[o]=i}return n.duration=parseFloat(n.duration),n.delay=parseFloat(n.delay),n}(o,e),r=i.value,a=b.arr(r)?r[1]:r,s=j(a),l=Y(e.target,t.name,s,e),h=n?n.to.original:l,m=b.arr(r)?r[0]:h,c=j(m)||j(l),p=s||c;return b.und(a)&&(a=h),i.from=it(m,p),i.to=it($(a,m),p),i.start=n?n.end:0,i.end=i.start+i.delay+i.duration+i.endDelay,i.easing=L(i.easing,i.duration),i.isPath=b.pth(r),i.isPathTargetInsideSVG=i.isPath&&b.svg(e.target),i.isColor=b.col(i.from.original),i.isColor&&(i.round=1),n=i,i}))}(e,t),i=o[o.length-1];return{type:n,property:e.name,animatable:t,tweens:o,duration:i.end,delay:o[0].delay,endDelay:i.endDelay}}}(t,e)}))}))),(function(t){return!b.und(t)}))}function ct(t,e){var n=t.length,o=function(t){return t.timelineOffset?t.timelineOffset:0},i={};return i.duration=n?Math.max.apply(Math,t.map((function(t){return o(t)+t.duration}))):e.duration,i.delay=n?Math.min.apply(Math,t.map((function(t){return o(t)+t.delay}))):e.delay,i.endDelay=n?i.duration-Math.max.apply(Math,t.map((function(t){return o(t)+t.duration-t.endDelay}))):e.endDelay,i}var pt=0,_t=[],ut=function(){var t;function e(n){for(var o=_t.length,i=0;i<o;){var r=_t[i];r.paused?(_t.splice(i,1),o--):(r.tick(n),i++)}t=i>0?requestAnimationFrame(e):void 0}return"undefined"!=typeof document&&document.addEventListener("visibilitychange",(function(){gt.suspendWhenDocumentHidden&&(dt()?t=cancelAnimationFrame(t):(_t.forEach((function(t){return t._onDocumentVisibility()})),ut()))})),function(){t||dt()&&gt.suspendWhenDocumentHidden||!(_t.length>0)||(t=requestAnimationFrame(e))}}();function dt(){return!!document&&document.hidden}function gt(t){void 0===t&&(t={});var e,n=0,o=0,i=0,r=0,a=null;function s(t){var e=window.Promise&&new Promise((function(t){return a=t}));return t.finished=e,e}var l=function(t){var e=E(f,t),n=E(v,t),o=function(t,e){var n=[],o=e.keyframes;for(var i in o&&(e=B(function(t){for(var e=R(F(t.map((function(t){return Object.keys(t)}))),(function(t){return b.key(t)})).reduce((function(t,e){return t.indexOf(e)<0&&t.push(e),t}),[]),n={},o=function(o){var i=e[o];n[i]=t.map((function(t){var e={};for(var n in t)b.key(n)?n==i&&(e.value=t[n]):e[n]=t[n];return e}))},i=0;i<e.length;i++)o(i);return n}(o),e)),e)b.key(i)&&n.push({name:i,tweens:st(e[i],t)});return n}(n,t),i=at(t.targets),r=mt(i,o),a=ct(r,n),s=pt;return pt++,B(e,{id:s,children:[],animatables:i,animations:r,duration:a.duration,delay:a.delay,endDelay:a.endDelay})}(t);function h(){var t=l.direction;"alternate"!==t&&(l.direction="normal"!==t?"normal":"reverse"),l.reversed=!l.reversed,e.forEach((function(t){return t.reversed=l.reversed}))}function m(t){return l.reversed?l.duration-t:t}function c(){n=0,o=m(l.currentTime)*(1/gt.speed)}function p(t,e){e&&e.seek(t-e.timelineOffset)}function _(t){for(var e=0,n=l.animations,o=n.length;e<o;){var i=n[e],r=i.animatable,a=i.tweens,s=a.length-1,h=a[s];s&&(h=R(a,(function(e){return t<e.end}))[0]||h);for(var m=w(t-h.start-h.delay,0,h.duration)/h.duration,c=isNaN(m)?1:h.easing(m),p=h.to.strings,_=h.round,u=[],d=h.to.numbers.length,g=void 0,x=0;x<d;x++){var C=void 0,f=h.to.numbers[x],v=h.from.numbers[x]||0;C=h.isPath?ot(h.value,c*f,h.isPathTargetInsideSVG):v+c*(f-v),_&&(h.isColor&&x>2||(C=Math.round(C*_)/_)),u.push(C)}var y=p.length;if(y){g=p[0];for(var P=0;P<y;P++){p[P];var M=p[P+1],T=u[P];isNaN(T)||(g+=M?T+M:T+" ")}}else g=u[0];lt[i.type](r.target,i.property,g,r.transforms),i.currentValue=g,e++}}function u(t){l[t]&&!l.passThrough&&l[t](l)}function d(t){var c=l.duration,d=l.delay,g=c-l.endDelay,x=m(t);l.progress=w(x/c*100,0,100),l.reversePlayback=x<l.currentTime,e&&function(t){if(l.reversePlayback)for(var n=r;n--;)p(t,e[n]);else for(var o=0;o<r;o++)p(t,e[o])}(x),!l.began&&l.currentTime>0&&(l.began=!0,u("begin")),!l.loopBegan&&l.currentTime>0&&(l.loopBegan=!0,u("loopBegin")),x<=d&&0!==l.currentTime&&_(0),(x>=g&&l.currentTime!==c||!c)&&_(c),x>d&&x<g?(l.changeBegan||(l.changeBegan=!0,l.changeCompleted=!1,u("changeBegin")),u("change"),_(x)):l.changeBegan&&(l.changeCompleted=!0,l.changeBegan=!1,u("changeComplete")),l.currentTime=w(x,0,c),l.began&&u("update"),t>=c&&(o=0,l.remaining&&!0!==l.remaining&&l.remaining--,l.remaining?(n=i,u("loopComplete"),l.loopBegan=!1,"alternate"===l.direction&&h()):(l.paused=!0,l.completed||(l.completed=!0,u("loopComplete"),u("complete"),!l.passThrough&&"Promise"in window&&(a(),s(l)))))}return s(l),l.reset=function(){var t=l.direction;l.passThrough=!1,l.currentTime=0,l.progress=0,l.paused=!0,l.began=!1,l.loopBegan=!1,l.changeBegan=!1,l.completed=!1,l.changeCompleted=!1,l.reversePlayback=!1,l.reversed="reverse"===t,l.remaining=l.loop,e=l.children;for(var n=r=e.length;n--;)l.children[n].reset();(l.reversed&&!0!==l.loop||"alternate"===t&&1===l.loop)&&l.remaining++,_(l.reversed?l.duration:0)},l._onDocumentVisibility=c,l.set=function(t,e){return ht(t,e),l},l.tick=function(t){i=t,n||(n=i),d((i+(o-n))*gt.speed)},l.seek=function(t){d(m(t))},l.pause=function(){l.paused=!0,c()},l.play=function(){l.paused&&(l.completed&&l.reset(),l.paused=!1,_t.push(l),c(),ut())},l.reverse=function(){h(),l.completed=!l.reversed,c()},l.restart=function(){l.reset(),l.play()},l.remove=function(t){Ct(rt(t),l)},l.reset(),l.autoplay&&l.play(),l}function xt(t,e){for(var n=e.length;n--;)J(t,e[n].animatable.target)&&e.splice(n,1)}function Ct(t,e){var n=e.animations,o=e.children;xt(t,n);for(var i=o.length;i--;){var r=o[i],a=r.animations;xt(t,a),a.length||r.children.length||o.splice(i,1)}n.length||o.length||e.pause()}gt.version="3.2.1",gt.speed=1,gt.suspendWhenDocumentHidden=!0,gt.running=_t,gt.remove=function(t){for(var e=rt(t),n=_t.length;n--;)Ct(e,_t[n])},gt.get=Y,gt.set=ht,gt.convertPx=G,gt.path=function(t,e){var n=b.str(t)?z(t)[0]:t,o=e||100;return function(t){return{property:t,el:n,svg:nt(n),totalLength:et(n)*(o/100)}}},gt.setDashoffset=function(t){var e=et(t);return t.setAttribute("stroke-dasharray",e),e},gt.stagger=function(t,e){void 0===e&&(e={});var n=e.direction||"normal",o=e.easing?L(e.easing):null,i=e.grid,r=e.axis,a=e.from||0,s="first"===a,l="center"===a,h="last"===a,m=b.arr(t),c=m?parseFloat(t[0]):parseFloat(t),p=m?parseFloat(t[1]):0,_=j(m?t[1]:t)||0,u=e.start||0+(m?c:0),d=[],g=0;return function(t,e,x){if(s&&(a=0),l&&(a=(x-1)/2),h&&(a=x-1),!d.length){for(var C=0;C<x;C++){if(i){var f=l?(i[0]-1)/2:a%i[0],v=l?(i[1]-1)/2:Math.floor(a/i[0]),y=f-C%i[0],P=v-Math.floor(C/i[0]),w=Math.sqrt(y*y+P*P);"x"===r&&(w=-y),"y"===r&&(w=-P),d.push(w)}else d.push(Math.abs(a-C));g=Math.max.apply(Math,d)}o&&(d=d.map((function(t){return o(t/g)*g}))),"reverse"===n&&(d=d.map((function(t){return r?t<0?-1*t:-t:Math.abs(g-t)})))}return u+(m?(p-c)/g:c)*(Math.round(100*d[e])/100)+_}},gt.timeline=function(t){void 0===t&&(t={});var e=gt(t);return e.duration=0,e.add=function(n,o){var i=_t.indexOf(e),r=e.children;function a(t){t.passThrough=!0}i>-1&&_t.splice(i,1);for(var s=0;s<r.length;s++)a(r[s]);var l=B(n,E(v,t));l.targets=l.targets||t.targets;var h=e.duration;l.autoplay=!1,l.direction=e.direction,l.timelineOffset=b.und(o)?h:$(o,h),a(e),e.seek(l.timelineOffset);var m=gt(l);a(m),r.push(m);var c=ct(r,t);return e.delay=c.delay,e.endDelay=c.endDelay,e.duration=c.duration,e.seek(0),e.reset(),e.autoplay&&e.play(),e},e},gt.easing=L,gt.penner=O,gt.random=function(t,e){return Math.floor(Math.random()*(e-t+1))+t};const ft=gt;class vt{constructor(t){this._hierachy=t,this._animations=[],this.name=""}getAnimations(){return this._animations}getAnimationByIndex(t){return this._animations[t]}addAnimation(t,e){this._animations.push({animation:t,component:e})}setName(t){this.name=t}getName(){return this.name}toJson(){return{animations:this._animations,name:this.name}}fromJson(t){this._animations=t.animations,this.name=t.name}play(){for(let t=0;t<this._animations.length;t++){let e=this._animations[t],n=Tt.getAnimationTemplate(e.animation),o=this._hierachy.getComponentHash()[e.component];Tt.startAnimation(o,n)}}}class yt{static fromJson(t,e){return new yt(t.name,e,t.animedef)}constructor(t,e,n){this.name=t,this._component=e,this._done=!1;let o=this;this.value=this._component.getCurrentValue(),null!=n.infinite&&n.infinite?(this.type=1,this.startTime=Date.now(),this.lasttime=this.startTime,this.easeInTime=parseInt(n.easeintime)/1e3,this.target=parseInt(n.value),this.previoustarget=0):(this.type=0,null!=n.startcolor&&(this.color=n.startcolor,n.startcolor=void 0,n.color=n.endcolor,n.endcolor=void 0),n.targets=this,n.autoplay=!1,n.complete=function(){o.anime.remove(),o._done=!0},this.anime=ft(n))}getName(){return this.name}getComponent(){return this._component}getDone(){return this._done}setDone(t){this._done=t}update(t){if(null!=this.color){this.anime.tick(t);let e=this._component.getReferenceNodes();for(let t=0;t<e.length;t++){let n=this.color.substring(5,this.color.length-1).split(",");Tt.viewer.model.setNodesFaceColor([e[t].nodeid],new Communicator.Color(parseInt(n[0]),parseInt(n[1]),parseInt(n[2])))}}else{if(1==this.type){let t=Date.now(),e=(t-this.lasttime)/1e3,n=(t-this.startTime)/1e3,o=this.target;n<this.easeInTime&&(o=this.easeInQuad(n,this.previoustarget,this.target-this.previoustarget,this.easeInTime));let i=this.value+e*o;this._component.set(i),this.lasttime=t,this.value=i}else this.anime.tick(t),this._component.set(parseFloat(this.value));this._component._touched=!0}}changeAnimationSpeed(t){this.previoustarget=this.target,this.target=t,this.startTime=Date.now(),this.lasttime=Date.now()}easeInQuad(t,e,n,o){return n*(t/=o)*t+e}}class Pt{constructor(){this._templateId=null,this._highestId=0,this._nodeid=void 0,this._componentNodeidHash=[],this._componentHash=[],this._ikTip=new Communicator.Point3(0,0,0),this._ikThreshold=1,this._ikSpeed=100,this._ikSamplingDistance=.1,this._ikSamplingDistanceTranslation=1,this._ikLearningRate=.1,this._interval=null,this._targetPoint=new Communicator.Point3(0,0,0),this._rootNode=Tt.viewer.model.createNode(Tt.getRootNode(),"hierachy"),this._rootComponent=this.createComponent(null,[],!0),this._rootComponent.setType(x.fixed),this._tipComponent=null,this._targetAnchorPosition=null,this._targetAnchorNode=null,this._enforceLimits=!1,this._touchedRewind=null,this._systems=[],this._dirty=!1}getComponentHash(){return this._componentHash}getRootComponent(){return this._rootComponent}getComponentById(t){let e=this._componentHash[t];return null!=e?e:null}getTemplateId(){return this._templateId}generateTemplate(){if(this._templateId){let t=this.toJson(this);Tt.updateTemplate(t)}else{this._templateId=n.generateGUID();let t=this.toJson();Tt.addTemplate(t)}}async _updateComponentsWithBehaviorRecursive(t){if(t&&(await t._execute(),await t._updateReferenceNodeMatrices(),t._children.length>0))for(let e=0;e<t._children.length;e++)await this._updateComponentsWithBehaviorRecursive(t._children[e])}async _updateComponentsRecursive(t){if(t&&(await t._updateReferenceNodeMatrices(),t._children.length>0))for(let e=0;e<t._children.length;e++)await this._updateComponentsRecursive(t._children[e])}async updateComponents(){this._enforceLimits&&this._saveHierachyState(),g.clearExecutedSystems(this),await this._updateComponentsWithBehaviorRecursive(this._rootComponent),await g.executeUnexecutedSystems(this),await this._updateComponentsWithBehaviorRecursive(this._rootComponent),this._enforceLimits&&this._cantResolve&&(this._restoreHierachyState(),await this._updateComponentsRecursive(this._rootComponent))}_saveHierachyStateRecursive(t){this._stateMap.push({nodeid:t._nodeid,matrix:Tt.viewer.model.getNodeMatrix(t._nodeid).copy()});let e=t._children;for(let t=0;t<e.length;t++)this._saveHierachyStateRecursive(e[t])}_saveHierachyState(){this._stateMap=[],this._cantResolve=!1,this._saveHierachyStateRecursive(this._rootComponent)}_restoreHierachyState(){for(let t=0;t<this._stateMap.length;t++)Tt.viewer.model.setNodeMatrix(this._stateMap[t].nodeid,this._stateMap[t].matrix);this._touchedRewind&&(Tt.viewer.model.setNodeMatrix(this._touchedRewind.nodeid,this._touchedRewind.matrix),this._touchedRewind=null)}setIkTip(t){this._ikTip=t}getIkTip(){return this._ikTip}setIkThreshold(t){this._ikThreshold=t}getIkThreshold(){return this._ikThreshold}setIkSpeed(t){this._ikSpeed=t}getIkSpeed(){return this._ikSpeed}setIkSamplingDistance(t){this._ikSamplingDistance=t}getIkSamplingDistance(){return this._ikSamplingDistance}setIkSamplingDistanceTranslation(t){this._ikSamplingDistanceTranslation=t}getIkSamplingDistanceTranslation(){return this._ikSamplingDistanceTranslation}setIkLearningRate(t){this._ikLearningRate=t}getIkLearningRate(){return this._ikLearningRate}isIKActive(){return!!this._interval}stopIK(){this._interval&&(clearInterval(this._interval),this._interval=null)}startIKFromHandle(){if(!this._interval){let t=this,e=Tt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle),n=Tt.viewer.model.getNodeNetMatrix(this._nodeid),o=Communicator.Matrix.inverse(n);this._interval=setInterval((async function(){if(e.getPosition()||t._targetAnchorPosition){if(t._targetAnchorPosition){let e=Tt.viewer.model.getNodeNetMatrix(t._targetAnchorNode),n=Communicator.Matrix.multiply(e,o);t._targetPoint=n.transform(t._targetAnchorPosition)}else{let e=Tt.viewer.model.getNodeMatrix(Tt.handleNode),n=Communicator.Matrix.multiply(e,o);t._targetPoint=n.transform(new Communicator.Point3(0,0,0))}for(let e=0;e<t._ikSpeed;e++)t.distanceFromIKTarget()>t._ikThreshold&&await t._inverseKinematics()}}),1)}}insertIKHandle(){let t=Tt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);t.removeHandles(),t.addHandles([Tt.handleNode],this._targetPoint),Tt.viewer.model.setNodesVisibility([Tt.handleNode],!0),t.showHandles()}setIKHandleToTip(t){let e=Tt.viewer.model.getNodeNetMatrix(this._nodeid),n=this.getReferenceNodeNetMatrix(this._tipComponent),o=Communicator.Matrix.multiply(n,e),i=o.transform(this._ikTip);o=new Communicator.Matrix,o.setTranslationComponent(i.x,i.y,i.z),this._targetPoint=i.copy(),Tt.viewer.model.setNodeMatrix(Tt.handleNode,o),t&&this.insertIKHandle()}setTipToHandlePosition(){let t=Tt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition();this._ikTip=this._tipComponent.transformPointToComponentSpace(t)}setTargetAnchorToHandlePosition(){let t=Tt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition(),e=Tt.viewer.selectionManager.getResults()[0].getNodeId(),n=Communicator.Matrix.inverse(Tt.viewer.model.getNodeNetMatrix(e));this._targetAnchorPosition=n.transform(t),this._targetAnchorNode=e}distanceFromIKTarget(){let t=this.getReferenceNodeNetMatrix(this._tipComponent).transform(this._ikTip);return Communicator.Point3.subtract(this._targetPoint,t).length()}removeAnimationFromComponents(t){this._rootComponent.removeAnimationRecursive(t)}toJson(){let t={version:Tt.getVersion(),_ikTip:this._ikTip.toJson(),_templateId:this._templateId,_ikSamplingDistance:this._ikSamplingDistance,_ikSamplingDistanceTranslation:this._ikSamplingDistanceTranslation,_ikLearningRate:this._ikLearningRate,_ikThreshold:this._ikThreshold,_ikSpeed:this._ikSpeed,_targetAnchorNode:this._targetAnchorNode};this._targetAnchorPosition&&(t._targetAnchorPosition=this._targetAnchorPosition.toJson()),t.components=this._rootComponent.toJson();let e=[],n=[];this._rootComponent.animToJson(e);for(let t in e){let e=Tt.getAnimationTemplate(t);null!=e&&(e._templateId=t,n.push(e))}t.animations=n,t.animationGroups=[];for(let e=0;e<Tt._animationGroups.length;e++){let n=Tt._animationGroups[e];n._hierachy==this&&t.animationGroups.push(n.toJson())}return t}fromJson(t){this._highestId=0,this._ikTip=Communicator.Point3.fromJson(t._ikTip),this._ikThreshold=t._ikThreshold,this._ikSpeed=t._ikSpeed,this._ikSamplingDistance=t._ikSamplingDistance,this._ikSamplingDistanceTranslation=t._ikSamplingDistanceTranslation,this._ikLearningRate=t._ikLearningRate,this._targetAnchorNode=t._targetAnchorNode,this._templateId=t._templateId,t._targetAnchorPosition&&(this._targetAnchorPosition=Communicator.Point3.fromJson(t._targetAnchorPosition));let e=this._rootNode;setTimeout((function(){Tt.viewer.model.deleteNode(e)}),100),this._rootNode=Tt.viewer.model.createNode(Tt.getRootNode(),"hierachy");let n=new C(null,this);for(n.fromJson(t.components,t.version),this._rootComponent=n;;){if(0==n.getChildren().length){this._tipComponent=n;break}n=n.getChildren()[0]}for(let t in this._componentHash){let e=this._componentHash[t];e.getBehavior()&&e.getBehavior().jsonFixup()}if(null!=t.animations)for(let e=0;e<t.animations.length;e++)Tt.addAnimationTemplateFromJson(t.animations[e]._templateId,t.animations[e]);if(null!=t.animationGroups)for(let e=0;e<t.animationGroups.length;e++){let n=new vt(this);n.fromJson(t.animationGroups[e]),Tt.addAnimationGroup(n)}return this.resetPivotSystems(),t}resetComponents(){for(let t in this._componentHash)this._componentHash[t].reset()}createComponent(t,e,n,o){let i=!0;null!=n&&0==n&&(i=!1);let r=new C(t,this);this._componentHash[r.getId()]=r,r.initialize(e,i),null==t?this._rootComponent=r:o?t.getChildren().unshift(r):t.getChildren().push(r),this._tipComponent=this._findTipComponent();for(let t=0;t<e.length;t++)this._componentNodeidHash[e[t]]=r;return r}createComponentFromSelection(t,e,n){let o=[],i=Tt.viewer.selectionManager.getResults();for(let t=0;t<i.length;t++)o.push(i[t].getNodeId());let r=this.createComponent(t,o,e,n);return r.setParametersFromHandle(),r}async rebuildComponentTree(){Tt.viewer.model.deleteNode(this._rootComponent.getNodeId()),this._rebuildComponentTreeRecursive(this._rootComponent)}async resetPivotSystems(){g.rebuildAllHashes(this),g.findAllSystems(this)}applyToModel(t){this._nodeid=t,this._componentNodeidHash=[];let e,n=Tt.viewer.model.getNodeChildren(t)[0];e=t==Tt.viewer.model.getRootNode()||null==t?new Communicator.Matrix:Tt.viewer.model.getNodeMatrix(t),this._applyToModelRecursive(this._rootComponent,Tt.viewer.model.getNodeIdOffset(n),e)}getReferenceNodeNetMatrix(t){return Tt.viewer.model.getNodeNetMatrix(t.getNodeId())}setEnforceLimits(t){this._enforceLimits=t,this._touchedRewind=null}getEnforceLimits(){return this._enforceLimits}_applyToModelRecursive(t,e,n){this._componentNodeidHash[t.getNodeId()]=t;let o=n.transform(Communicator.Point3.add(t.getCenter(),t.getAxis()));t.setCenter(n.transform(t.getCenter())),t.setAxis(Communicator.Point3.subtract(o,t.getCenter()).normalize()),t._parentMatrix=Communicator.Matrix.multiply(t.getParentMatrix(),n),t._behavior.applyToModel&&t._behavior.applyToModel(n);let i=t.getReferenceNodes();for(let o=0;o<i.length;o++)i[o].nodeid=e+i[o].nodeid,i[o].matrix=Communicator.Matrix.multiply(i[o].matrix,n),this._componentNodeidHash[i[o].nodeid]=t;if(t.getChildren().length>0)for(let o=0;o<t.getChildren().length;o++)this._applyToModelRecursive(t.getChildren()[o],e,n)}setDirty(t){this._dirty=!0}getDirty(){return this._dirty}getRootNode(){return this._rootNode}setNodeId(t){this._nodeid=t}_findTipComponent(){let t=this._rootComponent;for(;0!=t.getChildren().length;)t=t.getChildren()[0];return t}_rebuildComponentTreeRecursive(t){if(t.getParent()?t.setNodeId(Tt.viewer.model.createNode(t.getParent().getNodeId(),"component")):t.setNodeId(Tt.viewer.model.createNode(Tt.viewer.model.getRootNode(),"_rootComponent")),t.getChildren().length>0)for(let e=0;e<t.getChildren().length;e++)this._rebuildComponentTreeRecursive(t.getChildren()[e])}async _inverseKinematics(){let t=this._rootComponent;for(;;){if(t.getType()!=x.fixed&&!t.getBehavior()._fixedAxis&&t.getType()!=x.pistonController&&t.getType()!=x.prismaticAggregate){let e=await t.calculateGradient();await t.update(e)}if(t.getType()==x.prismaticAggregate){let e=await t.getBehavior().getExtraComponent1().calculateGradient();await t.getBehavior().getExtraComponent1().update(e),e=await t.getBehavior().getExtraComponent2().calculateGradient(),await t.getBehavior().getExtraComponent2().update(e)}if(0==t.getChildren().length||t.getType()==x.fixed&&t!=this._rootComponent)break;t=t.getChildren()[0]}await this.updateComponents()}}class wt{constructor(t){this._viewer=t,this._activeHighlight=null,this._currentSelItem=null,this._axis=null,this._axis2=null,this._disabled=!1}getPosition(){return this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition()}getAxis(){return this._axis}getSecondAxis(){return this._axis2}setAxis(t){this._axis=t}setSecondAxis(t){this._axis2=t}insertHandles(t){let e=this._currentSelItem,n=e.getNodeId(),o=e.getFaceEntity(),i=e.getLineEntity();if(null!==i||null!=o){let r,a=this._viewer.selectionManager.getResults();if(a.length>0){r=[];for(let t=0;t<a.length;t++)r.push(a[t].getNodeId())}else r=[n];if(null!=i){let t=i.getPoints();if(2===t.length){let e=Communicator.Point3.subtract(t[1],t[0]);this._axis=e.copy();let n=e.length(),o=t[0].copy().add(e.normalize().scale(n/2));this._addAxisTranslationHandle(o,e,r),this._addAxisTranslationHandle(o,e.copy().scale(-1),r),this._addAxisRotationHandle(o,e,r)}else this._getArcCenter(e).then((t=>{let e=this._viewer.model.getNodeNetMatrix(this._viewer.model.getNodeParent(n)),o=e.transform(new Communicator.Point3(0,0,0)),i=e.transform(t.normal),a=Communicator.Point3.cross(new Communicator.Point3(1,0,0),t.normal);a.length()<1e-5&&(a=Communicator.Point3.cross(new Communicator.Point3(0,1,0),t.normal));let s=e.transform(a),l=Communicator.Point3.subtract(i,o),h=Communicator.Point3.subtract(s,o);this._axis=l.copy(),this._axis2=h.copy();let m=t.center;this._addAxisTranslationHandle(m,l,r),this._addAxisTranslationHandle(m,l.copy().scale(-1),r),this._addAxisRotationHandle(m,l,r),this._addAxisTranslationHandle(m,h,r)}))}else{let e=o.getNormal(),n=o.getPosition().copy();if(n=t.controlDown()?this._currentSelItem.getPosition().copy():o.getBounding().center().copy(),t.altDown())this._addMainHandle(r,n);else{let t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),e);t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),e)),this._axis=e.copy(),this._axis2=t.copy(),this._addAxisTranslationHandle(n,e,r),this._addAxisTranslationHandle(n,e.copy().scale(-1),r),this._addAxisRotationHandle(n,e,r),this._addAxisTranslationHandle(n,t,r)}}}}disable(){this._disabled=!0}enable(){this._disabled=!1}onMouseDown(t){this._disabled||t.shiftDown()&&(this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).removeHandles(),this._axis=null,this._axis2=null,this.insertHandles(t),t.setHandled(!0))}onMouseMove(t){if(!this._disabled)if(t.shiftDown()){let e=t.getPosition(),n=this._viewer.view,o=new Communicator.PickConfig(Communicator.SelectionMask.Line);n.pickFromPoint(e,o).then((t=>{this._currentSelItem=t;let e=t.getNodeId();if(null!==e){if(this._viewer.model.getNodeType(e)!==Communicator.NodeType.BodyInstance)return;null!==this._activeHighlight?t.equals(this._activeHighlight)||(this._setNodeLineHighlighted(this._activeHighlight,!1),this._setNodeLineHighlighted(t,!0)):this._setNodeLineHighlighted(t,!0)}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}))}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}onMouseUp(t){this._disabled||t.shiftDown()&&t.setHandled(!0)}_setNodeLineHighlighted(t,e){if(null!==t){let n=t.getNodeId(),o=t.getLineEntity();if(null!==n&&null!==o){let i=o.getLineId();this._viewer.model._setNodeLineHighlighted(n,i,e),this._activeHighlight=e?t:null}}}_getArcCenter(t){let e=t.getNodeId(),n=t.getLineEntity();if(null!==e&&null!==n){let t=this._viewer.model;return t.getEdgeProperty(e,n.getLineId()).then((o=>{if(o instanceof Communicator.SubentityProperties.CircleElement){const n=o.origin;return t.getNodeNetMatrix(e).transform(n,n),{center:n,normal:o.normal}}if(o instanceof Communicator.SubentityProperties.LineElement){const t=n.getPoints();if(2===t.length)return Communicator.Point3.add(t[1],t[0]).scale(.5)}return null}))}return Promise.resolve(null)}_addMainHandle(t,e){let n=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);n.addHandles(t,e),n.showHandles()}_addAxisRotationHandle(t,e,n,o){o||(o=Communicator.Color.red());let i=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);i.addAxisRotationHandle(t,e,o),i.setNodeIds(n),i.showHandles()}_addAxisTranslationHandle(t,e,n,o){o||(o=Communicator.Color.red());let i=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);i.addAxisTranslationHandle(t.copy(),e,o),i.setNodeIds(n),i.showHandles()}}class Mt{constructor(t){this._viewer=t,this._mouseDown=!1,this._component=null,this._disabled=!1}disable(){Tt.viewer.selectionManager.clear(),this._disabled=!0}enable(){this._disabled=!1}onMouseDown(t){this._component&&!this._disabled&&(this._mouseDown=!0,this._startPosition=t.getPosition().copy(),this._currentcpos=this._component.getCurrentValue(),t.setHandled(!0))}onMouseMove(t){if(this._disabled)return;let e=t.getPosition();if(this._mouseDown){var n=t.getPosition();this._component.set(this._currentcpos+(n.x-this._startPosition.x)/2),this._component.getHierachy().updateComponents()}else{if(t.getButtons()!=Communicator.Buttons.None)return;let n=this._viewer.view,o=new Communicator.PickConfig(Communicator.SelectionMask.Line);this._component=null,Tt.viewer.selectionManager.clear(),n.pickFromPoint(e,o).then((t=>{let e=t.getNodeId();if(e){let t=null;for(;t=Tt.getComponentFromNodeId(e),null===t&&(e=this._viewer.model.getNodeParent(e),e!=this._viewer.model.getRootNode()););null!==t&&(t.getBehavior().getMovementType()!==x.revolute&&t.getBehavior().getMovementType()!==x.prismatic||t.getAnimationActive()||(t.selectReferenceNodes(),this._component=t))}}))}}onMouseUp(t){this._mouseDown&&!this._disabled&&(this._mouseDown=!1,this._component=null,t.setHandled(!0))}}class Tt{static initialize(t){Tt.viewer=t,Tt._version="1.0.1",Tt._hierachies=[],Tt._customTypeCallback=null,Tt._hierachyTemplates=[],Tt._animationTemplates=[],Tt._animations=[],Tt._animationGroups=[],Tt.handlePlacementOperator=null,Tt.componentMoveOperator=null,Tt._version="0.9.3",Tt._rootNode=t.model.createNode(t.model.getRootNode(),"KT_ROOT")}static getVersion(){return Tt._version}static getRootNode(){return Tt._rootNode}static getHandleOperator(){return Tt.handlePlacementOperator}static setupHandleOperator(){if(Tt.handlePlacementOperator)Tt.handlePlacementOperator.enable();else{Tt.handlePlacementOperator=new wt(Tt.viewer);let t=Tt.viewer.operatorManager.registerCustomOperator(Tt.handlePlacementOperator);Tt.viewer.operatorManager.push(t),Tt.handleNode=Tt.viewer.model.createNode(Tt.getRootNode(),"handlenode")}}static disableHandleOperator(){Tt.handlePlacementOperator.disable()}static setupComponentMoveOperator(){if(Tt.componentMoveOperator)Tt.componentMoveOperator.enable();else{Tt.componentMoveOperator=new Mt(Tt.viewer);let t=Tt.viewer.operatorManager.registerCustomOperator(Tt.componentMoveOperator);Tt.viewer.operatorManager.push(t)}}static disableComponentMoveOperator(){Tt.componentMoveOperator.disable()}static getHierachyTemplates(){return Tt._hierachyTemplates}static getHierachies(){return Tt._hierachies}static getAnimationTemplates(){return Tt._animationTemplates}static getAnimationTemplate(t){return Tt._animationTemplates[t]}static getAnimationGroups(){return Tt._animationGroups}static getHierachyByIndex(t){return Tt._hierachies[t]}static getComponentFromNodeId(t){for(let e=0;e<Tt._hierachies.length;e++){let n=Tt._hierachies[e]._componentNodeidHash[t];if(null!=n)return n}return null}static getHierachyFromNodeId(t){for(let e=0;e<Tt._hierachies.length;e++)if(Tt._hierachies[e]._nodeid==t)return Tt._hierachies[e]}static applyToModel(t,e){let n=new Pt;return n.fromJson(Tt._hierachyTemplates[t]),n.applyToModel(e),n.setNodeId(e),Tt._hierachies.push(n),n}static createHierachy(){let t=new Pt;return this._hierachies.push(t),t}static getHierachyIndex(t){for(let e=0;e<Tt._hierachies.length;e++)if(Tt._hierachies[e]==t)return e}static addTemplate(t){return Tt._hierachyTemplates[t._templateId]=t,t._templateId}static updateTemplate(t){Tt._hierachyTemplates[t._templateId]=t}static getTemplate(t){return Tt._hierachyTemplates[t]}static updateAnimationTemplate(t,e,n){let o=Tt._animationTemplates[t];o.name=e,o.anime=n,Tt._animationTemplates[t]=JSON.parse(JSON.stringify(o))}static addAnimationTemplate(t,e){let o={name:t,anime:e};o=JSON.parse(JSON.stringify(o));let i=n.generateGUID();return Tt._animationTemplates[i]=o,i}static addAnimationTemplateFromJson(t,e){let n=JSON.parse(JSON.stringify(e));Tt._animationTemplates[t]=n}static startAnimation(t,e){t.setAnimationActive(!0);let n=new yt("test",t,JSON.parse(JSON.stringify(e.anime)));Tt._animations.push(n),1==Tt._animations.length&&window.requestAnimationFrame(Tt._doAnimation)}static startAnimationDirect(t,e){t.setAnimationActive(!0);let n=new yt("test",t,e);Tt._animations.push(n),1==Tt._animations.length&&window.requestAnimationFrame(Tt._doAnimation)}static stopAnimation(t){for(let e=0;e<Tt._animations.length;e++)null!=t&&Tt._animations[e].getComponent()!=t||(Tt._animations[e].getComponent().setAnimationActive(!1),Tt._animations.splice(e,1),e--)}static changeAnimationSpeed(t,e){for(let n=0;n<Tt._animations.length;n++)null!=t&&Tt._animations[n].getComponent()!=t||Tt._animations[n].changeAnimationSpeed(e)}static deleteAnimationTemplate(t){delete Tt._animationTemplates[t];for(let e=0;e<Tt._hierachies.length;e++)Tt._hierachies[e].removeAnimationFromComponents(t)}static addAnimationGroup(t){return Tt._animationGroups.push(t),Tt._animationGroups.length-1}static startAnimationGroup(t){Tt._animationGroups[t].play()}static startAnimationGroupByName(t,e){for(let n=0;n<Tt._animationGroups.length;n++)Tt._animationGroups[n]._hierachy==t&&Tt._animationGroups[n].name==e&&Tt._animationGroups[n].play()}static setCustomBehaviorCreationCallback(t){Tt._customTypeCallback=t}static getCustomTypeCallback(){return Tt._customTypeCallback}static _doAnimation(t){if(Tt._animations.length>0){for(let t=0;t<Tt._hierachies.length;t++)Tt._hierachies[t].setDirty(!1);for(let e=0;e<Tt._animations.length;e++)Tt._animations[e].getComponent().getHierachy().setDirty(!0),Tt._animations[e].update(t),Tt._animations[e].getDone()&&(Tt._animations[e].getComponent().setAnimationActive(!1),Tt._animations.splice(e,1),e--);for(let t=0;t<Tt._hierachies.length;t++)Tt._hierachies[t].getDirty()&&Tt._hierachies[t].updateComponents();window.requestAnimationFrame(Tt._doAnimation)}}}KT=e})();